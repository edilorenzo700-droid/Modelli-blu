<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spazio AR">
<title>Spazio AR</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --A:#0A84FF;            /* accent blue */
  --AR:#5AC8FA;           /* AR wire blue */
  --AR2:rgba(90,200,250,.18);
  --SB:env(safe-area-inset-bottom,0px);
  --ST:env(safe-area-inset-top,44px);
}
html,body{width:100%;height:100%;overflow:hidden;background:#000;
  font-family:'Inter',-apple-system,sans-serif;
  -webkit-font-smoothing:antialiased;touch-action:none;user-select:none}

/* â”€â”€ VIDEO + CANVAS â”€â”€ */
#video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
#cvD{position:fixed;inset:0;width:100%;height:100%;z-index:1;pointer-events:none}

/* â”€â”€ NAV â”€â”€ */
#nav{position:fixed;top:0;left:0;right:0;z-index:90;
  padding:calc(var(--ST) + 8px) 16px 14px;
  background:linear-gradient(180deg,rgba(0,0,0,.72) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;gap:12px}
#navBack{display:flex;align-items:center;gap:5px;background:none;border:none;
  cursor:pointer;color:#fff;font-size:17px;font-weight:400;
  font-family:'Inter',sans-serif;padding:6px 0;
  -webkit-tap-highlight-color:transparent;flex-shrink:0}
#navBack svg{width:9px;height:15px}
#navBack:active{opacity:.5}
#navC{text-align:center;flex:1}
#navC h1{font-size:15px;font-weight:600;color:#fff;letter-spacing:-.3px}
#navC p{font-size:12px;color:rgba(255,255,255,.6);margin-top:1px}
#navBadge{flex-shrink:0;background:rgba(255,255,255,.15);
  border:1px solid rgba(255,255,255,.28);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  color:#fff;font-size:11px;font-weight:600;
  padding:5px 11px;border-radius:100px;letter-spacing:.5px}

/* â”€â”€ STATUS CHIP â”€â”€ */
#chip{position:fixed;top:calc(var(--ST) + 64px);
  left:50%;transform:translateX(-50%);z-index:89;white-space:nowrap;
  background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.22);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-radius:100px;padding:6px 16px;
  font-size:12px;font-weight:500;color:rgba(255,255,255,.85);
  pointer-events:none;transition:opacity .5s}

/* â”€â”€ BOTTOM â”€â”€ */
#bot{position:fixed;bottom:0;left:0;right:0;z-index:90;
  padding:0 16px calc(var(--SB) + 20px);
  display:flex;flex-direction:column;align-items:center;gap:8px}

/* â”€â”€ SINGLE PILL (un oggetto alla volta) â”€â”€ */
#mainPill{
  display:none;align-items:center;gap:12px;
  padding:14px 22px;
  background:var(--A);                        /* BLU SOLIDO */
  border:none;border-radius:100px;
  box-shadow:0 6px 28px rgba(10,132,255,.45),0 1px 0 rgba(255,255,255,.25) inset;
  cursor:pointer;color:#fff;font-size:16px;font-weight:600;
  max-width:380px;width:100%;
  -webkit-tap-highlight-color:transparent;
  animation:pIn .38s cubic-bezier(.34,1.56,.64,1) both}
#mainPill.visible{display:flex}
#mainPill:active{opacity:.82;transform:scale(.97)}
#pillIcon{font-size:20px}
#pillLabel{flex:1;letter-spacing:-.2px}
#pill3d{font-size:10px;font-weight:700;letter-spacing:.8px;
  background:rgba(255,255,255,.22);
  border:1px solid rgba(255,255,255,.35);
  color:#fff;padding:3px 9px;border-radius:100px;white-space:nowrap}
#pillConf{font-size:12px;color:rgba(255,255,255,.65);font-weight:400}

@keyframes pIn{from{opacity:0;transform:translateY(16px) scale(.88)}to{opacity:1;transform:none}}

/* secondary smaller pills (altri oggetti) */
#secPills{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;
  max-width:380px;width:100%}
.spill{display:flex;align-items:center;gap:6px;
  padding:8px 14px;
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,.32);
  border-radius:100px;cursor:pointer;color:#fff;
  font-size:13px;font-weight:500;
  -webkit-tap-highlight-color:transparent;
  animation:pIn .3s cubic-bezier(.34,1.56,.64,1) both}
.spill:active{opacity:.7}

/* â”€â”€ HINT â”€â”€ */
#hint{background:rgba(0,0,0,.45);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,.18);
  border-radius:16px;padding:10px 18px;text-align:center;
  max-width:380px;width:100%}
#hint h3{font-size:13px;font-weight:600;color:#fff;margin-bottom:1px}
#hint p{font-size:11px;color:rgba(255,255,255,.5);line-height:1.4}

/* â”€â”€ VIEWER â”€â”€ */
#viewer{position:fixed;inset:0;z-index:150;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .22s}
#viewer.open{opacity:1;pointer-events:all}
#vScrim{position:absolute;inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(7px);-webkit-backdrop-filter:blur(7px)}
#vPanel{position:relative;z-index:1;
  width:100%;max-width:560px;background:#fff;
  border-radius:28px 28px 0 0;
  box-shadow:0 -4px 60px rgba(0,0,0,.3);
  padding-bottom:calc(var(--SB) + 20px);
  transform:translateY(110%);
  transition:transform .42s cubic-bezier(.34,1.06,.64,1);
  max-height:91vh;display:flex;flex-direction:column;overflow:hidden}
#viewer.open #vPanel{transform:translateY(0)}
.vhandle{width:36px;height:4px;border-radius:2px;
  background:rgba(0,0,0,.12);margin:12px auto 0;flex-shrink:0}
#vClose{position:absolute;top:14px;right:16px;
  width:30px;height:30px;border-radius:50%;
  background:#f0f0f5;border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:#555;font-size:13px;font-weight:700;
  -webkit-tap-highlight-color:transparent;transition:background .15s}
#vClose:active{background:#e2e2ea}

/* â”€â”€ 3D AREA â”€â”€ */
#tWrap{width:100%;height:260px;flex-shrink:0;
  background:linear-gradient(160deg,#e6f3ff 0%,#eef8ff 50%,#e2f0fb 100%);
  border-bottom:1px solid rgba(0,0,0,.07);
  position:relative;overflow:hidden;cursor:grab;touch-action:none}
#tWrap:active{cursor:grabbing}
#tCanvas{width:100%;height:100%;display:block}

/* AR hint inside 3D */
#arHint{position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.45);border-radius:100px;
  padding:4px 14px;font-size:11px;color:rgba(255,255,255,.9);
  white-space:nowrap;pointer-events:none;transition:opacity .6s}

/* Controls BLUE */
#arCtrl{position:absolute;bottom:10px;right:10px;display:flex;gap:7px}
.ac{width:36px;height:36px;border-radius:50%;
  background:var(--A);                        /* BLU */
  border:none;
  box-shadow:0 2px 12px rgba(10,132,255,.45);
  display:flex;align-items:center;justify-content:center;
  font-size:15px;cursor:pointer;color:#fff;
  -webkit-tap-highlight-color:transparent;transition:opacity .15s}
.ac:active{opacity:.7}

/* Dimension labels on 3D */
.dl{position:absolute;pointer-events:none;
  background:rgba(90,200,250,.18);border:1px solid rgba(90,200,250,.5);
  border-radius:6px;padding:2px 9px;
  font-size:11px;font-weight:600;color:#0066aa;white-space:nowrap;
  font-family:'Georgia',serif}

/* â”€â”€ SHEET â”€â”€ */
#sScroll{flex:1;overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none}
#sScroll::-webkit-scrollbar{display:none}
.sbody{padding:18px 22px 0}
.stag{display:inline-flex;
  font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--A);background:rgba(10,132,255,.09);
  border:1px solid rgba(10,132,255,.20);
  border-radius:100px;padding:4px 10px;margin-bottom:10px}
.sname{font-size:28px;font-weight:700;color:#080810;letter-spacing:-.7px;
  margin-bottom:3px;line-height:1.1}
.stag2{font-size:13px;color:#5a5a72;margin-bottom:14px}
.cbadge{display:inline-flex;align-items:center;gap:5px;
  background:rgba(48,209,88,.09);border:1px solid rgba(48,209,88,.22);
  border-radius:100px;padding:4px 10px;margin-bottom:14px;
  font-size:12px;color:#1a8c3a;font-weight:500}
.cdot{width:6px;height:6px;border-radius:50%;background:#30d158}
.fblock{background:#f5f5f8;border:1px solid rgba(0,0,0,.06);
  border-radius:18px;padding:20px;text-align:center;margin-bottom:16px}
.fmain{font-size:30px;font-weight:300;color:#080810;letter-spacing:-.5px;
  font-family:'Georgia',serif;line-height:1.3;margin-bottom:7px}
.falt{font-size:14px;color:#5a5a72;font-family:'Georgia',serif}
.sdiv{height:1px;background:rgba(0,0,0,.07);margin:0 0 14px}
.sttl{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:#9898aa;margin-bottom:7px}
.sdesc{font-size:14px;color:#4a4a62;line-height:1.78;margin-bottom:16px}
.sfact{background:linear-gradient(135deg,#fff8e6,#fff3d4);
  border:1px solid rgba(255,180,0,.2);
  border-radius:14px;padding:13px 15px;margin-bottom:16px}
.sftext{font-size:13px;color:#7a5c00;line-height:1.65}
.vgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.vi{background:#f5f5f8;border:1px solid rgba(0,0,0,.06);border-radius:13px;padding:11px 14px}
.vs{font-size:17px;font-weight:500;color:#080810;font-family:'Georgia',serif;margin-bottom:3px}
.vn{font-size:11px;color:#9898aa;line-height:1.3}
.lbtn{display:flex;align-items:center;justify-content:center;gap:8px;
  padding:15px;border-radius:15px;background:var(--A);   /* BLU */
  color:#fff;font-size:15px;font-weight:600;cursor:pointer;
  box-shadow:0 4px 20px rgba(10,132,255,.35);
  -webkit-tap-highlight-color:transparent;transition:opacity .15s}
.lbtn:active{opacity:.8}

/* â”€â”€ WELCOME â”€â”€ */
#perm{position:fixed;inset:0;z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:20px;padding:40px;
  background:linear-gradient(160deg,#0f1923 0%,#1a2a3a 60%,#0f1923 100%)}
#perm.gone{display:none}
.pico{width:82px;height:82px;background:rgba(10,132,255,.18);
  border:1px solid rgba(10,132,255,.4);border-radius:24px;
  display:flex;align-items:center;justify-content:center;font-size:42px}
.ptit{font-size:32px;font-weight:700;color:#fff;letter-spacing:-.8px}
.psub{font-size:15px;color:rgba(255,255,255,.5);text-align:center;
  line-height:1.65;max-width:280px}
#startBtn{padding:15px 48px;background:var(--A);color:#fff;
  border:none;border-radius:100px;font-family:'Inter',sans-serif;
  font-size:16px;font-weight:600;cursor:pointer;
  box-shadow:0 4px 30px rgba(10,132,255,.5);
  -webkit-tap-highlight-color:transparent;transition:transform .15s,opacity .15s}
#startBtn:active{transform:scale(.96);opacity:.85}

/* â”€â”€ LOADING â”€â”€ */
#lbar{position:fixed;top:0;left:0;right:0;height:3px;
  background:rgba(255,255,255,.10);z-index:300;display:none}
#lbar.on{display:block}
#lfill{height:100%;background:linear-gradient(90deg,var(--A),#30d158);
  width:0%;transition:width .5s cubic-bezier(.4,0,.2,1)}

/* â”€â”€ ROTATE â”€â”€ */
#rotOv{display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.92);flex-direction:column;
  align-items:center;justify-content:center;gap:18px}
#rotOv.show{display:flex}
.rico{font-size:54px;animation:ra 2s ease-in-out infinite}
@keyframes ra{0%,100%{transform:rotate(0)}40%,60%{transform:rotate(90deg)}}
.rtxt{font-size:18px;font-weight:600;color:#fff}
.rsub{font-size:14px;color:rgba(255,255,255,.5)}

/* iPad */
@media(min-width:768px){
  #mainPill{max-width:480px}
  #vPanel{max-width:640px;border-radius:30px 30px 0 0}
  #tWrap{height:320px}
  .vgrid{grid-template-columns:1fr 1fr 1fr}
  .sname{font-size:34px}
  .fmain{font-size:36px}
}
@media(min-width:1024px){
  #bot{flex-direction:row;align-items:flex-end;justify-content:center;
    gap:16px;padding:0 40px calc(var(--SB) + 32px)}
  #mainPill{flex:2;max-width:360px}
  #hint{flex:1;max-width:260px;flex-shrink:0}
}
</style>
</head>
<body>

<div id="rotOv">
  <div class="rico">ğŸ“±</div>
  <div class="rtxt">Ruota il dispositivo</div>
  <div class="rsub">Usa la modalitÃ  verticale</div>
</div>
<div id="lbar"><div id="lfill"></div></div>

<!-- WELCOME -->
<div id="perm">
  <div class="pico">ğŸ”­</div>
  <div class="ptit">Spazio AR</div>
  <div class="psub">Punta la fotocamera. I modelli matematici appaiono in AR e puoi manipolarli.</div>
  <button id="startBtn" onclick="init()">Attiva fotocamera</button>
</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="cvD"></canvas>

<!-- NAV -->
<div id="nav">
  <button id="navBack" onclick="goBack()">
    <svg viewBox="0 0 9 15" fill="none"><path d="M8 1L1 7.5L8 14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    &nbsp;Indietro
  </button>
  <div id="navC"><h1>Spazio AR</h1><p>Formule nell'ambiente</p></div>
  <div id="navBadge">DEMO 01</div>
</div>

<div id="chip">Avvio in corsoâ€¦</div>

<!-- BOTTOM -->
<div id="bot">
  <div id="mainPill" onclick="openFromPill()">
    <span id="pillIcon">ğŸ’¡</span>
    <span id="pillLabel">Oggetto</span>
    <span id="pill3d">3D</span>
    <span id="pillConf">â€”%</span>
  </div>
  <div id="secPills"></div>
  <div id="hint">
    <h3>Muovi lentamente il dispositivo</h3>
    <p>Tocca l'oggetto rilevato per il modello 3D interattivo.</p>
  </div>
</div>

<!-- VIEWER -->
<div id="viewer">
  <div id="vScrim" onclick="closeViewer()"></div>
  <div id="vPanel">
    <div class="vhandle"></div>
    <button id="vClose" onclick="closeViewer()">âœ•</button>
    <div id="tWrap">
      <canvas id="tCanvas"></canvas>
      <div id="arHint">Trascina per ruotare Â· Pizzica per zoom</div>
      <div id="arCtrl">
        <div class="ac" onclick="resetCam()" title="Reset">âŸ³</div>
        <div class="ac" onclick="toggleWire()" title="Wireframe">â—ˆ</div>
      </div>
    </div>
    <div id="sScroll"><div id="sBody" class="sbody"></div></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATABASE â€” ogni entry ha: formule + tipo modello 3D preciso
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {

"person":{icon:"ğŸ§",label:"Persona",tagline:"Equilibrio statico â€” Î£F=0",subject:"FISICA â€” MECCANICA",
  main:"Î£F = 0",alt:"P = mÂ·g ,  N = âˆ’P",
  desc:"Un corpo fermo Ã¨ in equilibrio statico: la somma vettoriale di tutte le forze Ã¨ zero. Il peso P=mg punta verso il basso; la reazione N del pavimento bilancia con uguale intensitÃ  verso l'alto.",
  fact:"Un uomo di 70 kg esercita sul pavimento 686 N â€” il peso di 70 litri d'acqua.",
  vars:[{s:"Î£F",n:"Somma vettoriale forze [N]"},{s:"m",n:"Massa corporea [kg]"},{s:"g",n:"9.81 m/sÂ²"},{s:"N",n:"Reazione normale [N]"}],
  model:{type:"human", labels:["h","baricentro","P=mgâ†“","Nâ†‘"]}},

"chair":{icon:"ğŸª‘",label:"Sedia",tagline:"Pressione â€” P = F/A",subject:"FISICA â€” PRESSIONE",
  main:"P = F / A",alt:"F = m Â· g",
  desc:"Pressione = forza / area. Le gambe della sedia concentrano il peso su aree ridotte, amplificando la pressione sul pavimento. Minore l'area, maggiore la pressione.",
  fact:"Un tacco a spillo (1 cmÂ²) con 60 kg genera 600.000 Pa â€” piÃ¹ di un elefante!",
  vars:[{s:"P",n:"Pressione [Pa=N/mÂ²]"},{s:"F",n:"Forza peso [N]"},{s:"A",n:"Area di contatto [mÂ²]"},{s:"g",n:"9.81 m/sÂ²"}],
  model:{type:"box_chair", labels:["L","h","A=LÂ·p","P=F/A"]}},

"dining table":{icon:"ğŸªµ",label:"Tavolo",tagline:"Momento torcente â€” Î£Ï„=0",subject:"FISICA â€” STATICA",
  main:"Î£F=0 ,  Î£Ï„=0",alt:"Ï„ = F Â· d Â· sinÎ¸",
  desc:"Il tavolo Ã¨ in equilibrio completo: nÃ© traslazione (Î£F=0) nÃ© rotazione (Î£Ï„=0). I momenti torcenti Ï„=FÂ·dÂ·sinÎ¸ di tutti i carichi si bilanciano rispetto a qualsiasi punto.",
  fact:"Archimede: 'Datemi una leva abbastanza lunga e solleverÃ² il mondo.' Il momento Ã¨ questa idea.",
  vars:[{s:"Î£F",n:"Somma forze [N]"},{s:"Î£Ï„",n:"Somma momenti [NÂ·m]"},{s:"d",n:"Braccio forza [m]"},{s:"Î¸",n:"Angolo F-braccio"}],
  model:{type:"box_table", labels:["L=120cm","h=75cm","Ï„=FÂ·d","Î£F=0"]}},

"laptop":{icon:"ğŸ’»",label:"Laptop",tagline:"Potenza elettrica â€” P=VI",subject:"ELETTRICITÃ€",
  main:"P = V Â· I",alt:"P = IÂ²R = VÂ²/R",
  desc:"Il laptop converte energia elettrica in calcolo, luce e calore. Legge di Joule: P=IÂ²R. La CPU da 15W in un'ora scalderebbe 1 L d'acqua di 13Â°C.",
  fact:"Un laptop ha miliardi di transistor. Se fossero persone, ci vorrebbero 140 pianeti Terra.",
  vars:[{s:"P",n:"Potenza [W]"},{s:"V",n:"Tensione [V]"},{s:"I",n:"Corrente [A]"},{s:"R",n:"Resistenza [Î©]"}],
  model:{type:"flat_box", labels:["35cm","24cm","2cm","P=VI"]}},

"tv":{icon:"ğŸ“º",label:"Televisore",tagline:"Onde EM â€” c=Î»f",subject:"FISICA â€” ONDE EM",
  main:"c = Î» Â· f",alt:"E = h Â· f",
  desc:"Il segnale TV viaggia come onda EM a c=3Ã—10â¸ m/s. Lo schermo converte fotoni in luce visibile: ogni pixel emette R,G,B con E=hf diversa per ogni colore.",
  fact:"Il DVB-T2 usa 470â€“790 MHz. La luce visibile ha frequenze un milione di volte piÃ¹ alte!",
  vars:[{s:"c",n:"3Ã—10â¸ m/s"},{s:"Î»",n:"Lunghezza d'onda [m]"},{s:"f",n:"Frequenza [Hz]"},{s:"h",n:"Cost. Planck 6.63Ã—10â»Â³â´"}],
  model:{type:"flat_box", labels:["120cm","70cm","6cm","c=Î»f"]}},

"cell phone":{icon:"ğŸ“±",label:"Telefono",tagline:"Onde radio â€” c=Î»f",subject:"FISICA â€” ONDE EM",
  main:"c = Î» Â· f",alt:"E = hc / Î»",
  desc:"Il telefono trasmette onde EM. 5G a 26 GHz â†’ Î»â‰ˆ11.5 mm. PiÃ¹ alta la frequenza, piÃ¹ energia per fotone E=hf, piÃ¹ dati trasmissibili per unitÃ  di tempo.",
  fact:"5G a 26 GHz ha Î» di 11.5 mm â€” grande quanto un'unghia. Per questo le antenne 5G sono minuscole.",
  vars:[{s:"c",n:"3Ã—10â¸ m/s"},{s:"Î»",n:"Lunghezza d'onda"},{s:"f",n:"Frequenza [Hz]"},{s:"E",n:"Energia fotone [J]"}],
  model:{type:"flat_box", labels:["7.5cm","16cm","0.8cm","Î»=c/f"]}},

"book":{icon:"ğŸ“š",label:"Libro",tagline:"Parallelepipedo â€” V=LÂ·AÂ·P",subject:"GEOMETRIA",
  main:"V = L Â· A Â· P",alt:"âˆ«â‚áµ‡ f(x)dx = F(b)âˆ’F(a)",
  desc:"Il libro Ã¨ un parallelepipedo rettangolo. Come le pagine si sommano per formare il volume totale, l'integrale somma infiniti contributi infinitesimali. Derivata e integrale sono operazioni inverse.",
  fact:"Newton e Leibniz svilupparono il calcolo quasi simultaneamente nel XVII sec. â€” la piÃ¹ famosa disputa scientifica della storia.",
  vars:[{s:"V",n:"Volume [mÂ³]"},{s:"L",n:"Lunghezza [m]"},{s:"A",n:"Altezza [m]"},{s:"P",n:"ProfonditÃ  [m]"}],
  model:{type:"box_book", labels:["L=21cm","A=30cm","P=3cm","V=LÂ·AÂ·P"]}},

"bottle":{icon:"ğŸ¶",label:"Bottiglia",tagline:"Cilindro â€” P=Pâ‚€+Ïgh",subject:"FISICA â€” FLUIDOSTATICA",
  main:"P = Pâ‚€ + Ïgh",alt:"F_A = Ï Â· g Â· V",
  desc:"La bottiglia Ã¨ un cilindro. La pressione interna aumenta con h (legge di Stevin). Principio di Archimede: la spinta F_A=ÏgV Ã¨ pari al peso del fluido spostato.",
  fact:"Archimede capÃ¬ il suo principio nella vasca da bagno e corse nudo gridando 'Eureka!'",
  vars:[{s:"Ï",n:"DensitÃ  liquido [kg/mÂ³]"},{s:"h",n:"ProfonditÃ  [m]"},{s:"Pâ‚€",n:"Pressione atm. [Pa]"},{s:"V=Ï€rÂ²h",n:"Volume cilindro"}],
  model:{type:"cylinder", labels:["r","h","V=Ï€rÂ²h","P=Pâ‚€+Ïgh"]}},

"cup":{icon:"â˜•",label:"Tazza",tagline:"Cilindro â€” Q=mcÎ”T",subject:"FISICA â€” TERMODINAMICA",
  main:"Q = m Â· c Â· Î”T",alt:"V = Ï€ Â· rÂ² Â· h",
  desc:"La tazza Ã¨ un cilindro. V=Ï€rÂ²h determina la capienza. Il calore Q=mcÎ”T necessario dipende da massa e calore specifico dell'acqua (c=4186 J/kgÂ·K â€” tra i piÃ¹ alti in natura).",
  fact:"250 ml a 80Â°C contengono ~62.800 J di energia termica â€” abbastanza per sollevare 1 kg di 6.4 km!",
  vars:[{s:"Q",n:"Calore [J]"},{s:"m",n:"Massa [kg]"},{s:"c",n:"Calore spec. [J/kgÂ·K]"},{s:"V=Ï€rÂ²h",n:"Volume cilindro [mÂ³]"}],
  model:{type:"cylinder", labels:["r=4cm","h=10cm","V=Ï€rÂ²h","Q=mcÎ”T"]}},

"potted plant":{icon:"ğŸŒ¿",label:"Pianta",tagline:"Fotosintesi â€” Î”G=Î”Hâˆ’TÎ”S",subject:"CHIMICA",
  main:"6COâ‚‚+6Hâ‚‚Oâ†’Câ‚†Hâ‚â‚‚Oâ‚†+6Oâ‚‚",alt:"Î”G = Î”H âˆ’ TÂ·Î”S",
  desc:"La fotosintesi converte luce solare in glucosio. L'energia libera di Gibbs Î”G governa la spontaneitÃ : Î”G<0 spontanea. La fotosintesi Ã¨ endotermica: richiede energia luminosa.",
  fact:"Le piante producono 120 miliardi di tonnellate di glucosio/anno, assorbendo 180 Gt di COâ‚‚.",
  vars:[{s:"Î”G",n:"Energia Gibbs [J]"},{s:"Î”H",n:"Entalpia [J]"},{s:"Î”S",n:"Entropia [J/K]"},{s:"T",n:"Temperatura [K]"}],
  model:{type:"sphere", labels:["r","S=4Ï€rÂ²","V=4/3Ï€rÂ³","Î”G=Î”Hâˆ’TÎ”S"]}},

"vase":{icon:"ğŸº",label:"Vaso",tagline:"Solido di rivoluzione",subject:"MATEMATICA â€” ANALISI",
  main:"V = Ï€âˆ«[f(x)]Â²dx",alt:"S = 2Ï€âˆ«f(x)âˆš(1+fâ€²Â²)dx",
  desc:"Il vaso Ã¨ un solido di rivoluzione: si genera ruotando la curva f(x) attorno all'asse y. Il volume si calcola integrando le sezioni circolari di raggio f(x).",
  fact:"Il vasaio modella intuitivamente f(x) sul tornio: la rotazione genera il volume.",
  vars:[{s:"V",n:"Volume [mÂ³]"},{s:"f(x)",n:"Profilo (raggio)"},{s:"S",n:"Superficie laterale [mÂ²]"},{s:"Ï€",n:"3.14159â€¦"}],
  model:{type:"lathe", labels:["f(x)","asse y","V=Ï€âˆ«fÂ²dx","S=2Ï€âˆ«fÂ·ds"]}},

"clock":{icon:"â°",label:"Orologio",tagline:"Pendolo â€” T=2Ï€âˆš(L/g)",subject:"FISICA â€” OSCILLAZIONI",
  main:"T = 2Ï€ âˆš(L/g)",alt:"x(t) = AÂ·cos(Ï‰t+Ï†)",
  desc:"Il pendolo oscilla con periodo T che dipende solo da L e g, non dalla massa. Galileo scoprÃ¬ questa isocronia osservando un lampadario in cattedrale. Il moto nel tempo Ã¨ descritto da una funzione coseno.",
  fact:"Un pendolo di 1 metro: T=2.006 s â€” quasi esattamente 2 secondi!",
  vars:[{s:"T",n:"Periodo [s]"},{s:"L",n:"Lunghezza filo [m]"},{s:"g",n:"9.81 m/sÂ²"},{s:"Ï‰=2Ï€/T",n:"Pulsazione [rad/s]"}],
  model:{type:"pendulum", labels:["L","m","T=2Ï€âˆš(L/g)","x=AÂ·cos(Ï‰t)"]}},

"sports ball":{icon:"âš½",label:"Pallone",tagline:"Sfera â€” xÂ²+yÂ²+zÂ²=rÂ²",subject:"GEOMETRIA + FISICA",
  main:"xÂ² + yÂ² + zÂ² = rÂ²",alt:"x_max = vâ‚€Â²Â·sin(2Î¸)/g",
  desc:"Il pallone Ã¨ una sfera perfetta: ogni punto equidistante dal centro. Lanciato, descrive una parabola con gittata massima a Î¸=45Â°. L'effetto Magnus (rotazione) devia la traiettoria â€” le punizioni a banana.",
  fact:"Con vâ‚€=33 m/s e Î¸=45Â°, gittata teorica â‰ˆ111 m â€” la larghezza di un campo!",
  vars:[{s:"r",n:"Raggio [m]"},{s:"vâ‚€",n:"Vel. iniziale [m/s]"},{s:"Î¸",n:"Angolo lancio"},{s:"g",n:"9.81 m/sÂ²"}],
  model:{type:"sphere", labels:["r=11cm","xÂ²+yÂ²+zÂ²=rÂ²","S=4Ï€rÂ²","V=4/3Ï€rÂ³"]}},

"bowl":{icon:"ğŸ¥£",label:"Ciotola",tagline:"Paraboloide â€” y=xÂ²/(4p)",subject:"GEOMETRIA ANALITICA",
  main:"y = xÂ² / (4p)",alt:"dist(P,F)=dist(P,direttrice)",
  desc:"La ciotola Ã¨ un paraboloide di rotazione. La parabola Ã¨ il luogo dei punti equidistanti dal fuoco F e dalla direttrice. Le antenne paraboliche concentrano tutti i segnali paralleli nel fuoco.",
  fact:"La parabola riflette tutti i raggi paralleli all'asse nel fuoco â€” il principio di antenne e telescopi riflettori.",
  vars:[{s:"p",n:"Dist. vertice-fuoco"},{s:"F",n:"Fuoco (0,p)"},{s:"y",n:"Ordinata"},{s:"x",n:"Ascissa"}],
  model:{type:"paraboloid", labels:["y=xÂ²/4p","fuoco F","r","h"]}},

"lamp":{icon:"ğŸ’¡",label:"Lampada",tagline:"Sfera â€” xÂ²+yÂ²+zÂ²=rÂ²",subject:"GEOMETRIA ANALITICA",
  main:"xÂ² + yÂ² + zÂ² = rÂ²",alt:"(xâˆ’a)Â²+(yâˆ’b)Â²+(zâˆ’c)Â²=rÂ²",
  desc:"La lampadina Ã¨ una sfera. Ogni punto sulla superficie Ã¨ equidistante dal centro O. La sfera minimizza il rapporto S/V: per uguale volume, nessun altro solido ha superficie minore.",
  fact:"Raddoppiando r: superficie quadruplica, volume ottuplica. Gli elefanti hanno orecchie grandi per disperdere piÃ¹ calore.",
  vars:[{s:"r",n:"Raggio [m]"},{s:"(a,b,c)",n:"Centro della sfera"},{s:"S=4Ï€rÂ²",n:"Superficie [mÂ²]"},{s:"V=4/3Ï€rÂ³",n:"Volume [mÂ³]"}],
  model:{type:"sphere", labels:["r","O(0,0,0)","S=4Ï€rÂ²","V=4/3Ï€rÂ³"]}},

"window":{icon:"ğŸªŸ",label:"Finestra",tagline:"Legge di Snell â€” rifrazione",subject:"OTTICA",
  main:"nâ‚Â·sinÎ¸â‚ = nâ‚‚Â·sinÎ¸â‚‚",alt:"n = c/v",
  desc:"La luce cambia velocitÃ  attraversando il vetro (nâ‰ˆ1.5) e si rifrange. La legge di Snell lega angoli e indici di rifrazione. Lenti, prismi e fibre ottiche sfruttano questa proprietÃ .",
  fact:"Un diamante ha n=2.42. Il taglio brillante crea riflessione totale interna â€” per questo brilla cosÃ¬ tanto.",
  vars:[{s:"n",n:"Indice di rifrazione"},{s:"Î¸â‚",n:"Angolo incidenza"},{s:"Î¸â‚‚",n:"Angolo rifrazione"},{s:"v",n:"VelocitÃ  luce nel mezzo"}],
  model:{type:"refraction", labels:["Î¸â‚","Î¸â‚‚","nâ‚","nâ‚‚"]}},

"door":{icon:"ğŸšª",label:"Porta",tagline:"Momento torcente â€” Ï„=FÂ·d",subject:"FISICA â€” MECCANICA",
  main:"Ï„ = F Â· d Â· sinÎ¸",alt:"W = Ï„ Â· Î”Î¸",
  desc:"Aprire una porta richiede un momento torcente Ï„=FÂ·dÂ·sinÎ¸ rispetto all'asse delle cerniere. Maggiore Ã¨ d (distanza dall'asse), minore Ã¨ la forza necessaria per lo stesso momento.",
  fact:"Se la maniglia fosse a metÃ  porta, servirebbe il doppio della forza. Per questo la maniglia Ã¨ lontana dal cardine!",
  vars:[{s:"Ï„",n:"Momento torcente [NÂ·m]"},{s:"F",n:"Forza applicata [N]"},{s:"d",n:"Braccio [m]"},{s:"Î¸",n:"Angolo F-braccio"}],
  model:{type:"box_door", labels:["h=210cm","L=90cm","d=braccio","Ï„=FÂ·d"]}},

"refrigerator":{icon:"ğŸ§Š",label:"Frigorifero",tagline:"Macchina frigorifera â€” COP",subject:"FISICA â€” TERMODINAMICA",
  main:"COP = Q_c / W",alt:"Î·_Carnot=1âˆ’T_c/T_h",
  desc:"Il frigorifero trasferisce calore dal freddo al caldo spendendo lavoro W. COP=Q_c/W: un buon frigo spende 1 kWh per spostare 3 kWh di calore. Il II principio vieta il flusso spontaneo caldoâ†’freddo.",
  fact:"Il II principio della termodinamica: il calore non va mai spontaneamente dal freddo al caldo.",
  vars:[{s:"COP",n:"Coeff. di prestazione"},{s:"Q_c",n:"Calore sottratto [J]"},{s:"W",n:"Lavoro speso [J]"},{s:"T",n:"Temperatura [K]"}],
  model:{type:"box_tall", labels:["60cm","180cm","COP=Qc/W","T_c<T_h"]}},

"bicycle":{icon:"ğŸš²",label:"Bicicletta",tagline:"Momento angolare â€” L=IÏ‰",subject:"FISICA â€” MECCANICA",
  main:"L = I Â· Ï‰",alt:"I_disco = Â½ m rÂ²",
  desc:"La ruota (toro) conserva il momento angolare L=IÏ‰ in assenza di coppie esterne, stabilizzando la bicicletta. PiÃ¹ alta la velocitÃ  angolare Ï‰, piÃ¹ stabile il sistema.",
  fact:"Un giroscopio sfrutta lo stesso principio: Ã¨ usato nei satelliti e nei sistemi di navigazione.",
  vars:[{s:"L",n:"Momento angolare [kgÂ·mÂ²/s]"},{s:"I",n:"Momento inerzia [kgÂ·mÂ²]"},{s:"Ï‰",n:"Vel. angolare [rad/s]"},{s:"r",n:"Raggio ruota [m]"}],
  model:{type:"torus", labels:["R=35cm","r=4cm","I=mRÂ²","L=IÏ‰"]}},

"car":{icon:"ğŸš—",label:"Auto",tagline:"MRUA â€” s=vâ‚€t+Â½atÂ²",subject:"FISICA â€” CINEMATICA",
  main:"s = vâ‚€t + Â½atÂ²",alt:"vÂ² = vâ‚€Â² + 2as",
  desc:"L'auto in MRUA (moto rett. uniformemente accelerato) percorre spazio âˆ tÂ². 0â†’100 km/h in 8s: aâ‰ˆ3.5 m/sÂ², spazio percorso â‰ˆ112 m. Le leggi MRUA furono scoperte da Galileo su piani inclinati.",
  fact:"Una F1: 0â†’100 in â‰ˆ2s con aâ‰ˆ14 m/sÂ²=1.4g. Il pilota sente il suo peso aumentare del 40%.",
  vars:[{s:"s",n:"Spazio percorso [m]"},{s:"vâ‚€",n:"Vel. iniziale [m/s]"},{s:"a",n:"Accelerazione [m/sÂ²]"},{s:"t",n:"Tempo [s]"}],
  model:{type:"box_car", labels:["L=180cm","h=55cm","s=vâ‚€t+Â½atÂ²","a=Î”v/Î”t"]}},

"dog":{icon:"ğŸ•",label:"Cane",tagline:"Termoregolazione â€” Q=mcÎ”T",subject:"BIOLOGIA/FISICA",
  main:"Q = m Â· c Â· Î”T",alt:"Î¦ = ÏƒÂ·ÎµÂ·AÂ·Tâ´",
  desc:"I mammiferi mantengono Tâ‰ˆ37â€“39Â°C. Il calore metabolico Ã¨ disperso per conduzione, convezione, irraggiamento ed evaporazione. Il cane ansima per evaporare acqua dalla lingua.",
  fact:"Il cane non ha ghiandole sudoripare sul corpo (tranne le zampe): si raffredda solo ansimando.",
  vars:[{s:"Q",n:"Calore metabolico [J]"},{s:"c",n:"Calore specifico"},{s:"Îµ",n:"EmissivitÃ  â‰ˆ0.98"},{s:"T",n:"Temperatura [K]"}],
  model:{type:"sphere", labels:["T=38Â°C","Î¦=ÏƒÎµATâ´","Q=mcÎ”T","r"]}},

"cat":{icon:"ğŸˆ",label:"Gatto",tagline:"Conservazione â€” L=IÏ‰=cost",subject:"FISICA â€” MECCANICA",
  main:"L = I Â· Ï‰ = cost.",alt:"Iâ‚Ï‰â‚ = Iâ‚‚Ï‰â‚‚",
  desc:"Il gatto si raddrizza cadendo conservando L=0: ruota metÃ  corpo in un senso, l'altra metÃ  nell'opposto, i momenti si annullano ma la postura cambia. Effetto geometrico puro.",
  fact:"Il riflesso di raddrizzamento si completa in <0.1s a 30 cm d'altezza. Cadute da 5Â° piano sono piÃ¹ sicure del 2Â°: il corpo ha il tempo di rilassarsi.",
  vars:[{s:"L",n:"Momento angolare"},{s:"I",n:"Momento inerzia"},{s:"Ï‰",n:"Vel. angolare"},{s:"cost.",n:"Si conserva sempre"}],
  model:{type:"sphere", labels:["L=cost","Iâ‚Ï‰â‚=Iâ‚‚Ï‰â‚‚","r","massa"]}},

};

const ALIAS={
  "tvmonitor":"tv","sofa":"couch","pottedplant":"potted plant",
  "diningtable":"dining table","cellphone":"cell phone",
  "sportsball":"sports ball","mobilephone":"cell phone",
  "remote":"tv","monitor":"tv","person":"person",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS â€” engine 3D
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let R,S,C,AID, wireOn=false;
// Touch state
const TS={a:false,lx:0,ly:0,pd:0,rx:.28,ry:.5,z:1.0};

function initThree(){
  const cv=document.getElementById('tCanvas');
  const wr=document.getElementById('tWrap');
  R=new THREE.WebGLRenderer({canvas:cv,antialias:true,alpha:true});
  R.setPixelRatio(Math.min(devicePixelRatio,2));
  R.setSize(wr.clientWidth,wr.clientHeight);
  S=new THREE.Scene();
  C=new THREE.PerspectiveCamera(44,wr.clientWidth/wr.clientHeight,.01,100);
  C.position.z=3.2;
  setupTouch(wr);
}

function resizeThree(){
  const wr=document.getElementById('tWrap');
  if(!R||!wr) return;
  R.setSize(wr.clientWidth,wr.clientHeight);
  if(C){C.aspect=wr.clientWidth/wr.clientHeight;C.updateProjectionMatrix();}
}

function setupTouch(el){
  el.addEventListener('touchstart',e=>{
    e.preventDefault();TS.a=true;
    if(e.touches.length===1){TS.lx=e.touches[0].clientX;TS.ly=e.touches[0].clientY;}
    else TS.pd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
  },{passive:false});
  el.addEventListener('touchmove',e=>{
    e.preventDefault();
    if(e.touches.length===1){
      TS.ry+=(e.touches[0].clientX-TS.lx)*.013;
      TS.rx+=(e.touches[0].clientY-TS.ly)*.013;
      TS.lx=e.touches[0].clientX;TS.ly=e.touches[0].clientY;
    }else{
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      TS.z*=d/TS.pd;TS.z=Math.max(.3,Math.min(4,TS.z));TS.pd=d;
    }
  },{passive:false});
  el.addEventListener('touchend',()=>TS.a=false);
  let md=false,mlx=0,mly=0;
  el.addEventListener('mousedown',e=>{md=true;mlx=e.clientX;mly=e.clientY;TS.a=true;});
  window.addEventListener('mousemove',e=>{if(!md)return;
    TS.ry+=(e.clientX-mlx)*.009;TS.rx+=(e.clientY-mly)*.009;mlx=e.clientX;mly=e.clientY;});
  window.addEventListener('mouseup',()=>{md=false;TS.a=false;});
  el.addEventListener('wheel',e=>{TS.z*=e.deltaY>0?.92:1.08;TS.z=Math.max(.3,Math.min(4,TS.z));},{passive:true});
}

function resetCam(){TS.rx=.28;TS.ry=.5;TS.z=1;}
function toggleWire(){
  wireOn=!wireOn;
  S.traverse(o=>{
    if(o.isMesh&&o.material&&!o.material.wireframe)
      o.material.opacity=wireOn?0:.14;
  });
}

// Shared materials factory
function mats(c){
  return {
    fill:new THREE.MeshPhongMaterial({color:c,transparent:true,opacity:.14,side:THREE.DoubleSide,depthWrite:false}),
    wire:new THREE.MeshBasicMaterial({color:c,wireframe:true,transparent:true,opacity:.80}),
    edge:new THREE.LineBasicMaterial({color:c,transparent:true,opacity:.88}),
    solid:new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:.9}),
  };
}
function addMesh(geo,mt){
  S.add(new THREE.Mesh(geo,mt.fill));
  S.add(new THREE.Mesh(geo,mt.wire));
  S.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo,18),mt.edge));
}
function addAxes(){
  [[1,0,0,0xff4444],[0,1,0,0x44cc44],[0,0,1,0x4477ff]].forEach(([x,y,z,col])=>{
    const g=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(x*1.4,y*1.4,z*1.4)]);
    S.add(new THREE.Line(g,new THREE.LineBasicMaterial({color:col,transparent:true,opacity:.28})));
  });
}
function addLine3(pts,col){
  S.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),
    new THREE.LineBasicMaterial({color:col,transparent:true,opacity:.88})));
}
function clearScene(){
  if(AID) cancelAnimationFrame(AID);
  S.clear();
  S.add(new THREE.AmbientLight(0xffffff,.55));
  const d=new THREE.DirectionalLight(0x5AC8FA,1.3);d.position.set(2,3,4);S.add(d);
  const d2=new THREE.DirectionalLight(0xffffff,.35);d2.position.set(-2,-1,-2);S.add(d2);
}

// â”€â”€ MODEL BUILDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function build_sphere(c){
  const mt=mats(c);
  addMesh(new THREE.SphereGeometry(.95,48,32),mt);
  // Equatorial ring
  const eq=new THREE.TorusGeometry(.95,.008,8,80);
  S.add(new THREE.Mesh(eq,new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:.7})));
  // Meridian
  const mer=new THREE.TorusGeometry(.95,.008,8,80);
  mer.applyMatrix4(new THREE.Matrix4().makeRotationX(Math.PI/2));
  S.add(new THREE.Mesh(mer,new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:.5})));
  addAxes();
}

function build_cylinder(c){
  const mt=mats(c);
  addMesh(new THREE.CylinderGeometry(.55,.55,1.8,48,1,false),mt);
  // Top + bottom circles with labels
  [-.9,.9].forEach(y=>{
    const ring=new THREE.TorusGeometry(.55,.01,8,60);
    ring.applyMatrix4(new THREE.Matrix4().makeTranslation(0,y,0));
    S.add(new THREE.Mesh(ring,new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:.7})));
  });
  addAxes();
}

function build_box(c,w,h,d){
  const mt=mats(c);
  addMesh(new THREE.BoxGeometry(w,h,d),mt);
  addAxes();
}

function build_flat_box(c){
  build_box(c,1.9,1.15,.12);
}
function build_box_chair(c){
  const mt=mats(c);
  // seat
  addMesh(new THREE.BoxGeometry(1.2,.12,1.2),mt);
  // back
  const back=new THREE.BoxGeometry(1.2,1.2,.08);
  back.applyMatrix4(new THREE.Matrix4().makeTranslation(0,.66,-.56));
  S.add(new THREE.Mesh(back,mt.fill));
  S.add(new THREE.Mesh(back,mt.wire));
  S.add(new THREE.LineSegments(new THREE.EdgesGeometry(back,18),mt.edge));
  // 4 legs
  [[.5,-.8,.5],[-.5,-.8,.5],[.5,-.8,-.5],[-.5,-.8,-.5]].forEach(([x,y,z])=>{
    const lg=new THREE.CylinderGeometry(.04,.04,.9,8);
    lg.applyMatrix4(new THREE.Matrix4().makeTranslation(x,y,z));
    S.add(new THREE.Mesh(lg,mt.wire));
    S.add(new THREE.LineSegments(new THREE.EdgesGeometry(lg,10),mt.edge));
  });
  addAxes();
}
function build_box_table(c){
  const mt=mats(c);
  // tabletop
  addMesh(new THREE.BoxGeometry(2,.1,1.2),mt);
  // 4 legs
  [[.85,-.9,.5],[-.85,-.9,.5],[.85,-.9,-.5],[-.85,-.9,-.5]].forEach(([x,y,z])=>{
    const lg=new THREE.BoxGeometry(.08,1.6,.08);
    lg.applyMatrix4(new THREE.Matrix4().makeTranslation(x,y,z));
    S.add(new THREE.Mesh(lg,mt.wire));
    S.add(new THREE.LineSegments(new THREE.EdgesGeometry(lg,10),mt.edge));
  });
  addAxes();
}
function build_box_book(c){build_box(c,1.4,1.8,.18);}
function build_box_door(c){build_box(c,.08,2.1,1.2);}
function build_box_tall(c){build_box(c,1.0,2.0,.95);}
function build_box_car(c){
  const mt=mats(c);
  // body
  addMesh(new THREE.BoxGeometry(2,.7,1),mt);
  // roof
  const roof=new THREE.BoxGeometry(1.2,.5,.9);
  roof.applyMatrix4(new THREE.Matrix4().makeTranslation(0,.6,0));
  S.add(new THREE.Mesh(roof,mt.fill));
  S.add(new THREE.Mesh(roof,mt.wire));
  S.add(new THREE.LineSegments(new THREE.EdgesGeometry(roof,10),mt.edge));
  addAxes();
}

function build_torus(c){
  const mt=mats(c);
  addMesh(new THREE.TorusGeometry(.85,.16,18,80),mt);
  addAxes();
}

function build_paraboloid(c){
  const pts=[];
  for(let i=0;i<=28;i++){const t=i/28;pts.push(new THREE.Vector2(.88*t*t,.95*t-.48));}
  const mt=mats(c);
  addMesh(new THREE.LatheGeometry(pts,48),mt);
  addAxes();
}

function build_lathe(c){
  const pts=[
    new THREE.Vector2(0,-1.1),new THREE.Vector2(.3,-.9),new THREE.Vector2(.52,-.4),
    new THREE.Vector2(.45,.05),new THREE.Vector2(.36,.5),new THREE.Vector2(.46,.85),
    new THREE.Vector2(.4,1.0),new THREE.Vector2(.16,1.14),
  ];
  const mt=mats(c);
  addMesh(new THREE.LatheGeometry(pts,48),mt);
  addAxes();
}

// Human figure â€” head(sphere)+torso(cylinder)+arms+legs
function build_human(c){
  const mt=mats(c);
  // head
  const head=new THREE.SphereGeometry(.22,24,18);
  head.applyMatrix4(new THREE.Matrix4().makeTranslation(0,1.1,0));
  addMesh(head,mt);
  // torso
  const torso=new THREE.CylinderGeometry(.22,.28,.7,24,1);
  torso.applyMatrix4(new THREE.Matrix4().makeTranslation(0,.5,0));
  addMesh(torso,mt);
  // pelvis
  const pelvis=new THREE.CylinderGeometry(.28,.22,.3,24,1);
  pelvis.applyMatrix4(new THREE.Matrix4().makeTranslation(0,.02,0));
  addMesh(pelvis,mt);
  // left leg
  const ll=new THREE.CylinderGeometry(.1,.1,.85,16,1);
  ll.applyMatrix4(new THREE.Matrix4().makeTranslation(-.18,-.65,0));
  addMesh(ll,mt);
  // right leg
  const rl=new THREE.CylinderGeometry(.1,.1,.85,16,1);
  rl.applyMatrix4(new THREE.Matrix4().makeTranslation(.18,-.65,0));
  addMesh(rl,mt);
  // left arm
  const la=new THREE.CylinderGeometry(.07,.07,.65,12,1);
  la.applyMatrix4(new THREE.Matrix4().makeRotationZ(.4).multiply(new THREE.Matrix4().makeTranslation(-.45,.45,0)));
  addMesh(la,mt);
  // right arm
  const ra=new THREE.CylinderGeometry(.07,.07,.65,12,1);
  ra.applyMatrix4(new THREE.Matrix4().makeRotationZ(-.4).multiply(new THREE.Matrix4().makeTranslation(.45,.45,0)));
  addMesh(ra,mt);
  // floor line
  addLine3([new THREE.Vector3(-1,-1.08,0),new THREE.Vector3(1,-1.08,0)],0xaaaaaa);
  // force vectors
  addLine3([new THREE.Vector3(0,.5,0),new THREE.Vector3(0,-1.08,0)],0xff4444); // P down
  addLine3([new THREE.Vector3(0,-1.08,0),new THREE.Vector3(0,-.4,0)],0x44cc44); // N up
  addAxes();
}

function build_pendulum(c){
  const mt=mats(c);
  // pivot
  S.add(new THREE.Mesh(new THREE.SphereGeometry(.07,16,12),mt.solid));
  // string (line, animated)
  // bob
  const bobG=new THREE.SphereGeometry(.22,28,20);
  const bobFill=new THREE.Mesh(bobG,mt.fill);
  const bobWire=new THREE.Mesh(bobG,mt.wire);
  S.add(bobFill);S.add(bobWire);

  const piv=S.children[S.children.length-3]; // the pivot sphere
  piv.position.set(0,.98,0);

  addAxes();
  let t=0;
  const strGeo=new THREE.BufferGeometry();
  const strVerts=new Float32Array(6);
  strGeo.setAttribute('position',new THREE.BufferAttribute(strVerts,3));
  const strLine=new THREE.Line(strGeo,new THREE.LineBasicMaterial({color:c,transparent:true,opacity:.65}));
  S.add(strLine);

  function loop(){
    AID=requestAnimationFrame(loop);
    t+=.022; const a=.42*Math.sin(t);
    const bx=1.82*Math.sin(a), by=.98-1.82*(1-Math.cos(a));
    bobFill.position.set(bx,by-.22,0);
    bobWire.position.set(bx,by-.22,0);
    strVerts[0]=0;strVerts[1]=.98;strVerts[2]=0;
    strVerts[3]=bx;strVerts[4]=by-.0;strVerts[5]=0;
    strGeo.attributes.position.needsUpdate=true;
    if(!TS.a) TS.ry+=.004;
    S.rotation.y=TS.ry; S.rotation.x=TS.rx;
    C.position.z=3.2/TS.z; C.updateProjectionMatrix();
    R.render(S,C);
  }
  loop();
  return true; // signals own loop
}

function build_refraction(c){
  const slabG=new THREE.BoxGeometry(2.4,.5,.08);
  S.add(new THREE.Mesh(slabG,new THREE.MeshPhongMaterial({color:0xaaddff,transparent:true,opacity:.13,side:THREE.DoubleSide})));
  S.add(new THREE.Mesh(slabG,new THREE.MeshBasicMaterial({color:c,wireframe:true,transparent:true,opacity:.38})));
  addLine3([new THREE.Vector3(-1.1,.88,0),new THREE.Vector3(0,.25,0)],0xffaa00);
  addLine3([new THREE.Vector3(0,.25,0),new THREE.Vector3(.52,-.25,0)],c);
  addLine3([new THREE.Vector3(.52,-.25,0),new THREE.Vector3(1.1,-.88,0)],0xffaa00);
  // dashed normal
  const dg=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,.85,0),new THREE.Vector3(0,-.85,0)]);
  const dl2=new THREE.Line(dg,new THREE.LineDashedMaterial({color:0xffffff,dashSize:.07,gapSize:.05,transparent:true,opacity:.4}));
  dl2.computeLineDistances();S.add(dl2);
  // angle arcs labels via HTML only
  addAxes();
}

// â”€â”€ Main buildModel dispatcher
function buildModel(data){
  clearScene();
  wireOn=false;
  TS.rx=.28;TS.ry=.5;TS.z=1.0;
  const c=0x5AC8FA;
  const t=data.model.type;
  let hasOwnLoop=false;
  if(t==='sphere')       build_sphere(c);
  else if(t==='cylinder')build_cylinder(c);
  else if(t==='flat_box')build_flat_box(c);
  else if(t==='box_chair')build_box_chair(c);
  else if(t==='box_table')build_box_table(c);
  else if(t==='box_book')build_box_book(c);
  else if(t==='box_door')build_box_door(c);
  else if(t==='box_tall')build_box_tall(c);
  else if(t==='box_car')build_box_car(c);
  else if(t==='box')     build_box(c,1.6,1.0,0.8);
  else if(t==='torus')   build_torus(c);
  else if(t==='paraboloid') build_paraboloid(c);
  else if(t==='lathe')   build_lathe(c);
  else if(t==='human')   build_human(c);
  else if(t==='pendulum'){ hasOwnLoop=build_pendulum(c); }
  else if(t==='refraction') build_refraction(c);
  else build_sphere(c);

  injectDimLabels(data);
  if(!hasOwnLoop) startRenderLoop();
}

function startRenderLoop(){
  function loop(){
    AID=requestAnimationFrame(loop);
    if(!TS.a) TS.ry+=.005;
    S.rotation.y=TS.ry; S.rotation.x=TS.rx;
    C.position.z=3.2/TS.z; C.updateProjectionMatrix();
    R.render(S,C);
  }
  loop();
}

function injectDimLabels(data){
  document.querySelectorAll('.dl').forEach(e=>e.remove());
  const wr=document.getElementById('tWrap');
  const pos=[
    {top:'10px',left:'10px'},{top:'10px',right:'10px'},
    {bottom:'46px',left:'10px'},{bottom:'46px',right:'10px'},
  ];
  (data.model.labels||[]).forEach((txt,i)=>{
    if(i>3) return;
    const el=document.createElement('div');
    el.className='dl';
    el.textContent=txt;
    Object.assign(el.style,{position:'absolute',...pos[i]});
    wr.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETECTION â€” un solo oggetto "vincitore" alla volta
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tfModel=null;
let curDet=null, secDets=[];
let detecting=false;

const video=document.getElementById('video');
const cvD=document.getElementById('cvD');
const ctx=cvD.getContext('2d');

async function init(){
  document.getElementById('perm').classList.add('gone');
  chip('Avvio fotocameraâ€¦'); loader(true,0);

  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false});
    video.srcObject=stream;
    await new Promise(r=>video.onloadedmetadata=r);
    resizeCv();
  }catch(e){
    chip('Fotocamera non disponibile'); loader(true,100);
    setTimeout(()=>loader(false),700); startDemo(); return;
  }

  chip('Carico il modelloâ€¦'); loader(true,30);
  try{
    tfModel=await cocoSsd.load({base:'mobilenet_v2'});
    loader(true,92);
  }catch(e){
    chip('Modello non disponibile'); loader(true,100);
    setTimeout(()=>loader(false),700); startDemo(); return;
  }
  loader(true,100); setTimeout(()=>loader(false),600);
  chip('Pronto â€” punta il dispositivo');
  setTimeout(()=>{document.getElementById('chip').style.opacity='0';},3500);
  initThree();
  detectionLoop();
}

window.addEventListener('resize',()=>{resizeCv();resizeThree();});
function resizeCv(){cvD.width=innerWidth;cvD.height=innerHeight;}

async function detectionLoop(){
  while(true){
    await sleep(700);
    if(video.readyState<2||detecting) continue;
    detecting=true;
    try{
      // Threshold 0.45 â€” solo rilievi affidabili
      const preds=await tfModel.detect(video,6,0.45);
      process(preds);
    }catch(_){}
    detecting=false;
  }
}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

function process(preds){
  const found=[];
  const seen=new Set();
  for(const p of preds){
    let cls=p.class.toLowerCase();
    if(ALIAS[cls]) cls=ALIAS[cls];
    if(seen.has(cls)) continue;
    seen.add(cls);
    const data=DB[cls];
    if(!data) continue;
    found.push({cls,score:p.score,bbox:p.bbox,data});
  }
  found.sort((a,b)=>b.score-a.score);

  // PRIMARY = highest score
  const primary=found[0]||null;
  // SECONDARY = rest (max 3)
  const secondary=found.slice(1,4);

  drawBoxes(found, primary);
  updatePills(primary, secondary);
}

function drawBoxes(found, primary){
  ctx.clearRect(0,0,cvD.width,cvD.height);
  if(!video.videoWidth) return;
  const sx=cvD.width/video.videoWidth;
  const sy=cvD.height/video.videoHeight;

  found.forEach((det,idx)=>{
    const isPrimary=idx===0;
    const [bx,by,bw,bh]=det.bbox;
    const x=bx*sx,y=by*sy,w=bw*sx,h=bh*sy,rr=12;
    const stroke=isPrimary?'rgba(90,200,250,.95)':'rgba(255,255,255,.45)';
    const lw=isPrimary?2.2:1.2;

    ctx.shadowColor=isPrimary?stroke:'transparent';
    ctx.shadowBlur=isPrimary?14:0;

    // rounded rect box
    ctx.beginPath();
    ctx.moveTo(x+rr,y);ctx.lineTo(x+w-rr,y);ctx.quadraticCurveTo(x+w,y,x+w,y+rr);
    ctx.lineTo(x+w,y+h-rr);ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
    ctx.lineTo(x+rr,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-rr);
    ctx.lineTo(x,y+rr);ctx.quadraticCurveTo(x,y,x+rr,y);ctx.closePath();
    ctx.fillStyle=isPrimary?'rgba(90,200,250,.05)':'rgba(255,255,255,.02)';
    ctx.fill();
    ctx.strokeStyle=stroke;ctx.lineWidth=lw;ctx.stroke();
    ctx.shadowBlur=0;

    if(isPrimary){
      // corner brackets
      const bl=18;ctx.strokeStyle=stroke;ctx.lineWidth=2.8;
      [[x,y,bl,bl],[x+w,y,-bl,bl],[x,y+h,bl,-bl],[x+w,y+h,-bl,-bl]].forEach(([cx,cy,dx,dy])=>{
        ctx.beginPath();ctx.moveTo(cx+dx,cy);ctx.lineTo(cx,cy);ctx.lineTo(cx,cy+dy);ctx.stroke();
      });
      // formula overlay
      if(w>110&&h>80){
        ctx.font='italic 14px Georgia,serif';
        ctx.fillStyle='rgba(90,200,250,.65)';
        ctx.textAlign='center';
        ctx.fillText(det.data.main,x+w/2,y+h/2+6);
        ctx.textAlign='left';
      }
    }

    // label pill
    const lbl=det.data.icon+' '+det.data.label+(isPrimary?'  '+Math.round(det.score*100)+'%':'');
    ctx.font=(isPrimary?'600':'500')+' 12px Inter,-apple-system,sans-serif';
    const tw=ctx.measureText(lbl).width;
    const lw2=tw+14,lh2=22,lx2=x,ly2=Math.max(4,y-lh2-5);
    ctx.fillStyle=isPrimary?'rgba(10,132,255,.85)':'rgba(0,0,0,.6)';
    ctx.beginPath();ctx.roundRect(lx2,ly2,lw2,lh2,6);ctx.fill();
    ctx.fillStyle='#fff';ctx.fillText(lbl,lx2+7,ly2+15);
  });
}

let _curData=null;

function updatePills(primary, secondary){
  const mp=document.getElementById('mainPill');
  const sp=document.getElementById('secPills');

  if(!primary){
    mp.classList.remove('visible');
    sp.innerHTML='';
    _curData=null;
    return;
  }

  // Animate only if changed
  if(!_curData||_curData.label!==primary.data.label){
    _curData=primary.data;
    mp.style.animation='none';
    requestAnimationFrame(()=>{mp.style.animation='';});
  }
  document.getElementById('pillIcon').textContent=primary.data.icon;
  document.getElementById('pillLabel').textContent=primary.data.label;
  document.getElementById('pillConf').textContent=Math.round(primary.score*100)+'%';
  mp.classList.add('visible');

  // Secondary pills
  sp.innerHTML='';
  secondary.forEach(det=>{
    const el=document.createElement('div');
    el.className='spill';
    el.innerHTML=`${det.data.icon} ${det.data.label}`;
    el.onclick=()=>openViewer(det.data,Math.round(det.score*100));
    sp.appendChild(el);
  });
}

function openFromPill(){
  if(_curData) openViewer(_curData, parseInt(document.getElementById('pillConf').textContent));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openViewer(data,conf){
  if(!R) initThree();
  buildModel(data);
  document.getElementById('sBody').innerHTML=sheetHTML(data,conf);
  document.getElementById('viewer').classList.add('open');
  document.getElementById('arHint').style.opacity='1';
  setTimeout(()=>{document.getElementById('arHint').style.opacity='0';},4500);
}

function closeViewer(){
  document.getElementById('viewer').classList.remove('open');
  if(AID){cancelAnimationFrame(AID);AID=null;}
  document.querySelectorAll('.dl').forEach(e=>e.remove());
}

function sheetHTML(d,conf){
  return `
    <div class="stag">${d.subject}</div>
    <div class="sname">${d.icon}&ensp;${d.label}</div>
    <div class="stag2">${d.tagline}</div>
    ${conf?`<div class="cbadge"><span class="cdot"></span>Rilevato con ${conf}% di accuratezza</div>`:''}
    <div class="fblock">
      <div class="fmain">${d.main}</div>
      <div class="falt">${d.alt}</div>
    </div>
    <div class="sdiv"></div>
    <div class="sttl">Spiegazione</div>
    <div class="sdesc">${d.desc}</div>
    ${d.fact?`<div class="sfact"><div class="sftext"><strong>ğŸ’¡ Lo sapevi?</strong> ${d.fact}</div></div>`:''}
    <div class="sttl">Variabili</div>
    <div class="vgrid">${d.vars.map(v=>`<div class="vi"><div class="vs">${v.s}</div><div class="vn">${v.n}</div></div>`).join('')}</div>
    <div class="lbtn">â†’ Apri la lezione nell'app</div>
  `;
}

// swipe to close
let _ty0=0;
document.getElementById('vPanel').addEventListener('touchstart',e=>{_ty0=e.touches[0].clientY;},{passive:true});
document.getElementById('vPanel').addEventListener('touchmove',e=>{
  if(e.touches[0].clientY-_ty0>85) closeViewer();
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEMO MODE (no camera)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDemo(){
  initThree();
  const seq=["lamp","bowl","bottle","clock","sports ball","vase","cup","bicycle","person","book"];
  let i=0;
  const show=()=>{
    const data=DB[seq[i++%seq.length]];
    const score=.88+Math.random()*.10;
    _curData=data;
    document.getElementById('pillIcon').textContent=data.icon;
    document.getElementById('pillLabel').textContent=data.label;
    document.getElementById('pillConf').textContent=Math.round(score*100)+'%';
    document.getElementById('mainPill').classList.add('visible');
  };
  show(); setInterval(show,5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goBack(){
  if(document.referrer){history.back();return;}
  if(window.history.length>1){history.back();return;}
  const p=window.location.pathname;
  window.location.href=window.location.origin+p.substring(0,p.lastIndexOf('/demo1'))+'/index.html';
}
function chip(msg){const e=document.getElementById('chip');e.textContent=msg;e.style.opacity='1';}
function loader(on,pct){
  document.getElementById('lbar').classList.toggle('on',on);
  if(pct!=null) document.getElementById('lfill').style.width=pct+'%';
}
function checkOri(){
  const l=innerWidth>innerHeight,s=Math.min(innerWidth,innerHeight)<500;
  document.getElementById('rotOv').classList.toggle('show',l&&s);
}
window.addEventListener('resize',checkOri);
window.addEventListener('orientationchange',checkOri);
checkOri();
</script>
</body>
</html>
