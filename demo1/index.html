<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spazio AR">
<title>Spazio AR</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --accent:#0A84FF;
  --ar:#5AC8FA;
  --ar-dim:rgba(90,200,250,0.15);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --safe-top:env(safe-area-inset-top,44px);
}
html,body{width:100%;height:100%;overflow:hidden;background:#000;
  font-family:'Inter',-apple-system,sans-serif;-webkit-font-smoothing:antialiased;
  touch-action:none;user-select:none}

/* â”€â”€ LAYERS â”€â”€ */
#video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
#cvDetect{position:fixed;inset:0;width:100%;height:100%;z-index:1;pointer-events:none}

/* â”€â”€ NAVBAR â”€â”€ */
#navbar{position:fixed;top:0;left:0;right:0;z-index:90;
  padding:calc(var(--safe-top) + 8px) 16px 14px;
  background:linear-gradient(180deg,rgba(0,0,0,0.7) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;gap:12px}
#navBack{display:flex;align-items:center;gap:4px;background:none;border:none;
  cursor:pointer;color:#fff;font-size:17px;font-weight:400;
  font-family:'Inter',sans-serif;padding:6px 0;
  -webkit-tap-highlight-color:transparent;flex-shrink:0}
#navBack svg{width:9px;height:15px;margin-right:2px}
#navBack:active{opacity:.55}
#navCenter{text-align:center;flex:1}
#navCenter h1{font-size:15px;font-weight:600;color:#fff;letter-spacing:-.3px}
#navCenter p{font-size:12px;color:rgba(255,255,255,.6);margin-top:1px}
#navBadge{flex-shrink:0;background:rgba(255,255,255,.15);
  border:1px solid rgba(255,255,255,.3);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  color:#fff;font-size:11px;font-weight:600;
  padding:5px 11px;border-radius:100px;letter-spacing:.5px}

/* â”€â”€ BOTTOM BAR â”€â”€ */
#bottomBar{position:fixed;bottom:0;left:0;right:0;z-index:90;
  padding:0 16px calc(var(--safe-bottom) + 22px);
  display:flex;flex-direction:column;align-items:center;gap:8px}
#pillList{display:flex;flex-direction:column;align-items:center;gap:7px;
  width:100%;max-height:200px;overflow-y:auto;
  -ms-overflow-style:none;scrollbar-width:none;padding:2px 0}
#pillList::-webkit-scrollbar{display:none}
.pill{display:flex;align-items:center;gap:10px;padding:12px 18px;
  background:rgba(255,255,255,.20);
  backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);
  border:1px solid rgba(255,255,255,.35);
  border-radius:100px;
  box-shadow:0 6px 24px rgba(0,0,0,.20),0 1px 0 rgba(255,255,255,.4) inset;
  cursor:pointer;color:#fff;font-size:15px;font-weight:500;
  max-width:380px;width:100%;
  -webkit-tap-highlight-color:transparent;
  animation:pillIn .35s cubic-bezier(.34,1.56,.64,1) both}
.pill:active{opacity:.75}
.pill.selected{background:rgba(10,132,255,.28);border-color:rgba(10,132,255,.55)}
.pill-icon{font-size:18px}
.pill-label{flex:1}
.pill-3d{font-size:10px;font-weight:700;letter-spacing:.8px;
  background:rgba(90,200,250,.22);border:1px solid rgba(90,200,250,.5);
  color:var(--ar);padding:3px 8px;border-radius:100px;white-space:nowrap}
.pill-conf{font-size:11px;color:rgba(255,255,255,.45);font-weight:400}
@keyframes pillIn{from{opacity:0;transform:translateY(14px) scale(.9)}to{opacity:1;transform:none}}

#hintCard{background:rgba(255,255,255,.15);
  backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);
  border:1px solid rgba(255,255,255,.28);
  border-radius:18px;padding:12px 18px;text-align:center;
  max-width:380px;width:100%}
#hintCard h3{font-size:14px;font-weight:600;color:#fff;margin-bottom:2px}
#hintCard p{font-size:11px;color:rgba(255,255,255,.55);line-height:1.4}

/* â”€â”€ VIEWER PANEL â”€â”€ */
#viewer{position:fixed;inset:0;z-index:150;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .22s}
#viewer.open{opacity:1;pointer-events:all}
#viewerScrim{position:absolute;inset:0;
  background:rgba(0,0,0,.32);
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
#viewerPanel{position:relative;z-index:1;
  width:100%;max-width:560px;
  background:#fff;
  border-radius:28px 28px 0 0;
  box-shadow:0 -4px 60px rgba(0,0,0,.28);
  padding-bottom:calc(var(--safe-bottom) + 20px);
  transform:translateY(110%);
  transition:transform .42s cubic-bezier(.34,1.06,.64,1);
  max-height:91vh;display:flex;flex-direction:column;overflow:hidden}
#viewer.open #viewerPanel{transform:translateY(0)}
.panel-handle{width:36px;height:4px;border-radius:2px;
  background:rgba(0,0,0,.13);margin:12px auto 0;flex-shrink:0}
#panelClose{position:absolute;top:14px;right:16px;
  width:28px;height:28px;border-radius:50%;
  background:#f0f0f5;border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:#666;font-size:12px;font-weight:700;
  -webkit-tap-highlight-color:transparent}
#panelClose:active{background:#e0e0ea}

/* â”€â”€ 3D AREA â”€â”€ */
#threeWrap{width:100%;height:260px;flex-shrink:0;
  background:linear-gradient(160deg,#e8f4ff 0%,#eef8ff 50%,#e4f0fb 100%);
  border-bottom:1px solid rgba(0,0,0,.06);
  position:relative;overflow:hidden;cursor:grab}
#threeWrap:active{cursor:grabbing}
#threeCanvas{width:100%;height:100%;display:block}
#arHint{position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.42);border-radius:100px;
  padding:4px 14px;font-size:11px;color:rgba(255,255,255,.88);
  white-space:nowrap;pointer-events:none;transition:opacity .5s}
#arCtrls{position:absolute;bottom:10px;right:10px;display:flex;gap:6px}
.actrl{width:34px;height:34px;border-radius:50%;
  background:rgba(255,255,255,.88);border:1px solid rgba(0,0,0,.10);
  box-shadow:0 2px 8px rgba(0,0,0,.12);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.actrl:active{background:#e8e8ee}
/* dim labels */
.dlabel{position:absolute;pointer-events:none;
  background:rgba(90,200,250,.15);border:1px solid rgba(90,200,250,.45);
  border-radius:6px;padding:2px 8px;
  font-size:11px;font-weight:600;color:#006699;white-space:nowrap}

/* â”€â”€ SHEET â”€â”€ */
#sheetScroll{flex:1;overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none}
#sheetScroll::-webkit-scrollbar{display:none}
.sbody{padding:18px 22px 0}
.stag{display:inline-flex;align-items:center;
  font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--accent);background:rgba(10,132,255,.09);
  border:1px solid rgba(10,132,255,.20);
  border-radius:100px;padding:4px 10px;margin-bottom:10px}
.sname{font-size:28px;font-weight:700;color:#0a0a0f;letter-spacing:-.7px;
  margin-bottom:3px;line-height:1.1}
.stagline{font-size:13px;color:#5a5a72;margin-bottom:14px}
.cbadge{display:inline-flex;align-items:center;gap:5px;
  background:rgba(48,209,88,.09);border:1px solid rgba(48,209,88,.25);
  border-radius:100px;padding:4px 10px;margin-bottom:14px;
  font-size:12px;color:#1a8c3a;font-weight:500}
.cdot{width:6px;height:6px;border-radius:50%;background:#30d158}
.fblock{background:#f5f5f8;border:1px solid rgba(0,0,0,.06);
  border-radius:18px;padding:20px;text-align:center;margin-bottom:16px}
.fmain{font-size:32px;font-weight:300;color:#0a0a0f;letter-spacing:-.5px;
  font-family:'Georgia',serif;line-height:1.3;margin-bottom:7px}
.falt{font-size:14px;color:#5a5a72;font-family:'Georgia',serif}
.sdiv{height:1px;background:rgba(0,0,0,.07);margin:0 0 14px}
.dtitle{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:#9898aa;margin-bottom:7px}
.sdesc{font-size:14px;color:#5a5a72;line-height:1.75;margin-bottom:16px}
.ffact{background:linear-gradient(135deg,#fff8e6,#fff3d4);
  border:1px solid rgba(255,180,0,.2);
  border-radius:14px;padding:13px 15px;margin-bottom:16px;
  display:flex;gap:10px}
.fftext{font-size:13px;color:#7a5c00;line-height:1.6}
.vtitle{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:#9898aa;margin-bottom:9px}
.vgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.vitem{background:#f5f5f8;border:1px solid rgba(0,0,0,.06);border-radius:13px;padding:11px 14px}
.vsym{font-size:17px;font-weight:500;color:#0a0a0f;font-family:'Georgia',serif;margin-bottom:3px}
.vname{font-size:11px;color:#9898aa;line-height:1.3}
.lbtn{display:flex;align-items:center;justify-content:center;gap:8px;
  padding:15px;border-radius:15px;background:var(--accent);
  color:#fff;font-size:15px;font-weight:600;cursor:pointer;
  box-shadow:0 4px 20px rgba(10,132,255,.3);
  -webkit-tap-highlight-color:transparent;transition:opacity .15s}
.lbtn:active{opacity:.82}

/* â”€â”€ WELCOME â”€â”€ */
#permScreen{position:fixed;inset:0;z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:18px;padding:40px;
  background:linear-gradient(160deg,#111827 0%,#1f2937 60%,#111827 100%)}
#permScreen.gone{display:none}
.picon{width:80px;height:80px;background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.22);border-radius:22px;
  display:flex;align-items:center;justify-content:center;font-size:40px}
.ptitle{font-size:30px;font-weight:700;color:#fff;letter-spacing:-.8px}
.psub{font-size:15px;color:rgba(255,255,255,.55);text-align:center;
  line-height:1.65;max-width:290px}
#startBtn{padding:15px 44px;background:var(--accent);color:#fff;
  border:none;border-radius:100px;font-family:'Inter',sans-serif;
  font-size:16px;font-weight:600;cursor:pointer;
  box-shadow:0 4px 28px rgba(10,132,255,.45);
  -webkit-tap-highlight-color:transparent;transition:transform .15s,opacity .15s}
#startBtn:active{transform:scale(.96);opacity:.85}

/* â”€â”€ LOADING â”€â”€ */
#loadBar{position:fixed;top:0;left:0;right:0;height:3px;
  background:rgba(255,255,255,.10);z-index:300;display:none}
#loadBar.on{display:block}
#loadFill{height:100%;background:linear-gradient(90deg,var(--accent),#30d158);
  width:0%;transition:width .5s cubic-bezier(.4,0,.2,1)}
#statusChip{position:fixed;top:calc(var(--safe-top) + 66px);
  left:50%;transform:translateX(-50%);z-index:89;white-space:nowrap;
  background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.32);
  backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);
  border-radius:100px;padding:7px 16px;
  font-size:12px;font-weight:500;color:rgba(255,255,255,.8);
  pointer-events:none;transition:opacity .4s}

/* â”€â”€ ROTATE â”€â”€ */
#rotOv{display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.92);flex-direction:column;
  align-items:center;justify-content:center;gap:18px}
#rotOv.show{display:flex}
.ricon{font-size:54px;animation:rAnim 2s ease-in-out infinite}
@keyframes rAnim{0%,100%{transform:rotate(0deg)}40%,60%{transform:rotate(90deg)}}
.rtxt{font-size:18px;font-weight:600;color:#fff}
.rsub{font-size:14px;color:rgba(255,255,255,.5)}

/* â”€â”€ IPAD â”€â”€ */
@media(min-width:768px){
  .pill{max-width:480px}
  #viewerPanel{max-width:640px;border-radius:30px 30px 0 0}
  #threeWrap{height:320px}
  .vgrid{grid-template-columns:1fr 1fr 1fr}
  .sname{font-size:34px}
  .fmain{font-size:38px}
}
@media(min-width:1024px){
  #bottomBar{flex-direction:row;align-items:flex-end;justify-content:center;
    gap:14px;padding:0 40px calc(var(--safe-bottom) + 32px)}
  #pillList{flex-direction:row;flex-wrap:wrap;justify-content:center;max-height:none}
  .pill{width:auto;min-width:160px;max-width:220px}
  #hintCard{width:auto;max-width:300px;flex-shrink:0}
}
</style>
</head>
<body>
<div id="rotOv"><div class="ricon">ğŸ“±</div><div class="rtxt">Ruota il dispositivo</div><div class="rsub">Usa la modalitÃ  verticale</div></div>
<div id="loadBar"><div id="loadFill"></div></div>

<!-- WELCOME -->
<div id="permScreen">
  <div class="picon">ğŸ”­</div>
  <div class="ptitle">Spazio AR</div>
  <div class="psub">Punta la fotocamera verso gli oggetti. I modelli matematici appaiono in realtÃ  aumentata e puoi manipolarli.</div>
  <button id="startBtn" onclick="init()">Attiva fotocamera</button>
</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="cvDetect"></canvas>

<div id="navbar">
  <button id="navBack" onclick="goBack()">
    <svg viewBox="0 0 9 15" fill="none"><path d="M8 1L1 7.5L8 14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    Indietro
  </button>
  <div id="navCenter"><h1>Spazio AR</h1><p>Formule nell'ambiente</p></div>
  <div id="navBadge">DEMO 01</div>
</div>

<div id="statusChip">Avvio in corsoâ€¦</div>

<div id="bottomBar">
  <div id="pillList"></div>
  <div id="hintCard">
    <h3>Muovi lentamente il dispositivo</h3>
    <p>Tocca un oggetto rilevato per vedere formula e modello 3D interattivo.</p>
  </div>
</div>

<!-- VIEWER: 3D + sheet -->
<div id="viewer">
  <div id="viewerScrim" onclick="closeViewer()"></div>
  <div id="viewerPanel">
    <div class="panel-handle"></div>
    <button id="panelClose" onclick="closeViewer()">âœ•</button>

    <!-- THREE.JS -->
    <div id="threeWrap">
      <canvas id="threeCanvas"></canvas>
      <div id="arHint">Trascina per ruotare Â· Pizzica per zoom</div>
      <div id="arCtrls">
        <div class="actrl" onclick="resetCam()" title="Reset vista">âŸ³</div>
        <div class="actrl" onclick="toggleWire()" title="Wireframe">â—ˆ</div>
      </div>
    </div>

    <div id="sheetScroll">
      <div id="sheetBody" class="sbody"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
  "person":{icon:"ğŸ§",label:"Persona",tagline:"Equilibrio statico â€” Seconda legge di Newton",subject:"FISICA â€” MECCANICA",
    main:"Î£F = 0",alt:"P = m Â· g ,  N = âˆ’P",
    desc:"Un corpo fermo Ã¨ in equilibrio statico: la somma vettoriale di tutte le forze Ã¨ zero. Il peso P = mg punta verso il basso; la reazione normale N del pavimento bilancia verso l'alto con uguale intensitÃ .",
    fact:"Un uomo di 70 kg esercita sul pavimento circa 686 N â€” il peso di 70 litri d'acqua.",
    vars:[{s:"Î£F",n:"Somma forze [N]"},{s:"m",n:"Massa [kg]"},{s:"g",n:"9.81 m/sÂ²"},{s:"N",n:"Reazione vincolare [N]"}],
    model:{type:"cylinder",color:0x5AC8FA,dims:["h","r"],formulas:["V = Ï€rÂ²h","S_lat = 2Ï€rh"]}},
  "chair":{icon:"ğŸª‘",label:"Sedia",tagline:"Pressione â€” distribuzione del carico",subject:"FISICA â€” PRESSIONE",
    main:"P = F / A",alt:"F = m Â· g",
    desc:"La pressione Ã¨ forza distribuita su superficie. Le gambe della sedia concentrano il peso su piccole aree, aumentando enormemente la pressione locale.",
    fact:"Un tacco a spillo (1 cmÂ²) con 60 kg genera 600.000 Pa â€” piÃ¹ di un elefante!",
    vars:[{s:"P",n:"Pressione [Pa]"},{s:"F",n:"Forza peso [N]"},{s:"A",n:"Area contatto [mÂ²]"},{s:"g",n:"9.81 m/sÂ²"}],
    model:{type:"box",color:0x5AC8FA,dims:["L","h","P"],formulas:["V = LÂ·hÂ·P","A = LÂ·P"]}},
  "dining table":{icon:"ğŸªµ",label:"Tavolo",tagline:"Equilibrio statico e momenti torcenti",subject:"FISICA â€” STATICITÃ€",
    main:"Î£F = 0  ,  Î£Ï„ = 0",alt:"Ï„ = F Â· d Â· sinÎ¸",
    desc:"Il tavolo Ã¨ in equilibrio completo: nÃ© si muove nÃ© ruota. I momenti torcenti Ï„=FÂ·dÂ·sinÎ¸ di tutti i carichi si bilanciano. Una gamba corta rompe l'equilibrio creando un momento risultante non nullo.",
    fact:"Archimede: 'Datemi una leva abbastanza lunga e solleverÃ² il mondo.' Il momento torcente Ã¨ esattamente questa idea.",
    vars:[{s:"Î£F",n:"Somma forze [N]"},{s:"Î£Ï„",n:"Somma momenti [NÂ·m]"},{s:"d",n:"Braccio [m]"},{s:"Î¸",n:"Angolo"}],
    model:{type:"box",color:0x5AC8FA,dims:["L = 1.2m","h = 0.75m"],formulas:["Ï„ = FÂ·dÂ·sinÎ¸","Î£F = 0"]}},
  "laptop":{icon:"ğŸ’»",label:"Laptop",tagline:"Effetto Joule â€” dissipazione elettrica",subject:"ELETTRICITÃ€",
    main:"P = V Â· I",alt:"P = IÂ²R = VÂ²/R",
    desc:"Il laptop converte energia elettrica in calcolo, luce e calore. La CPU da 15W in un'ora scalderebbe 1 litro d'acqua di 13Â°C. La resistenza R dei transistor a nanometro Ã¨ il segreto dell'efficienza moderna.",
    fact:"Un laptop ha miliardi di transistor. Se fossero persone, ci vorrebbero 140 pianeti Terra.",
    vars:[{s:"P",n:"Potenza [W]"},{s:"V",n:"Tensione [V]"},{s:"I",n:"Corrente [A]"},{s:"R",n:"Resistenza [Î©]"}],
    model:{type:"box",color:0x5AC8FA,dims:["35cm","24cm","2cm"],formulas:["P = VÂ·I","Q = PÂ·t"]}},
  "tv":{icon:"ğŸ“º",label:"Televisore",tagline:"Onde elettromagnetiche â€” luce e segnale",subject:"FISICA â€” ONDE EM",
    main:"c = Î» Â· f",alt:"E = h Â· f",
    desc:"Il segnale TV viaggia come onda EM a velocitÃ  della luce. Lo schermo converte fotoni in luce: E=hf per ogni colore. I pixel emettono tre colori primari (RGB) a frequenze diverse.",
    fact:"Il digitale DVB-T2 usa 470â€“790 MHz. La luce visibile ha frequenze un milione di volte piÃ¹ alte!",
    vars:[{s:"c",n:"3Ã—10â¸ m/s"},{s:"Î»",n:"Lunghezza d'onda [m]"},{s:"f",n:"Frequenza [Hz]"},{s:"h",n:"Cost. di Planck"}],
    model:{type:"box",color:0x5AC8FA,dims:["120cm","70cm","6cm"],formulas:["c = Î»Â·f","E = hf"]}},
  "cell phone":{icon:"ğŸ“±",label:"Telefono",tagline:"Onde radio â€” 5G e quantizzazione",subject:"FISICA â€” ONDE EM",
    main:"c = Î» Â· f",alt:"E = h Â· f = hc/Î»",
    desc:"Il telefono trasmette onde EM a GHz. 5G a 26 GHz ha Î» â‰ˆ 11.5 mm â€” grande quanto un'unghia. PiÃ¹ alta la frequenza, piÃ¹ energia per fotone, piÃ¹ velocitÃ  di trasmissione dati.",
    fact:"Un segnale 5G a 26 GHz ha Î» di soli 11.5 mm. Ecco perchÃ© le antenne 5G sono piccole.",
    vars:[{s:"c",n:"3Ã—10â¸ m/s"},{s:"Î»",n:"Lunghezza d'onda"},{s:"f",n:"Frequenza [Hz]"},{s:"E",n:"Energia fotone [J]"}],
    model:{type:"box",color:0x5AC8FA,dims:["7.5cm","16cm","0.8cm"],formulas:["c = Î»Â·f","E = hf"]}},
  "book":{icon:"ğŸ“š",label:"Libro",tagline:"Teorema fondamentale del calcolo",subject:"MATEMATICA â€” ANALISI",
    main:"âˆ«â‚áµ‡ f(x) dx = F(b) âˆ’ F(a)",alt:"Fâ€²(x) = f(x)",
    desc:"Come le pagine si sommano per formare il volume, l'integrale somma infiniti valori infinitesimali. Derivata e integrale sono operazioni inverse: scoperta rivoluzionaria di Newton e Leibniz nel XVII secolo.",
    fact:"Newton e Leibniz svilupparono il calcolo quasi simultaneamente â€” dando luogo alla piÃ¹ famosa disputa scientifica della storia.",
    vars:[{s:"âˆ«",n:"Integrale (S da 'summa')"},{s:"f(x)",n:"Funzione integranda"},{s:"F(x)",n:"Primitiva"},{s:"dx",n:"Differenziale"}],
    model:{type:"box",color:0x5AC8FA,dims:["21cm","30cm","3cm"],formulas:["V = LÂ·AÂ·P","âˆ«f(x)dx = F(b)-F(a)"]}},
  "bottle":{icon:"ğŸ¶",label:"Bottiglia",tagline:"Legge di Stevin â€” cilindro e fluidi",subject:"FISICA â€” FLUIDOSTATICA",
    main:"P = Pâ‚€ + Ïgh",alt:"F_A = Ï Â· g Â· V",
    desc:"La bottiglia Ã¨ un cilindro. La pressione interna aumenta con la profonditÃ  h. Il principio di Archimede: la spinta verso l'alto F_A = ÏgV Ã¨ pari al peso del fluido spostato.",
    fact:"Archimede capÃ¬ il suo principio nella vasca da bagno e corse nudo gridando 'Eureka!'",
    vars:[{s:"Ï",n:"DensitÃ  [kg/mÂ³]"},{s:"h",n:"ProfonditÃ  [m]"},{s:"Pâ‚€",n:"Pressione atm."},{s:"V",n:"Volume [mÂ³]"}],
    model:{type:"cylinder",color:0x5AC8FA,dims:["r = 3cm","h = 25cm"],formulas:["V = Ï€rÂ²h","P = Pâ‚€+Ïgh"]}},
  "cup":{icon:"â˜•",label:"Tazza",tagline:"Cilindro â€” calore specifico",subject:"FISICA â€” TERMODINAMICA",
    main:"Q = m Â· c Â· Î”T",alt:"V = Ï€ Â· rÂ² Â· h",
    desc:"La tazza Ã¨ un cilindro. V = Ï€rÂ²h determina quanta acqua contiene. Il calore Q = mcÎ”T per scaldarla dipende dalla massa e dal calore specifico dell'acqua (c = 4186 J/kgÂ·K â€” uno dei piÃ¹ alti in natura).",
    fact:"250 ml a 80Â°C contengono ~62.800 J â€” abbastanza per sollevare 1 kg di 6.4 km!",
    vars:[{s:"Q",n:"Calore [J]"},{s:"m",n:"Massa [kg]"},{s:"c",n:"Calore spec. [J/kgÂ·K]"},{s:"V=Ï€rÂ²h",n:"Volume cilindro"}],
    model:{type:"cylinder",color:0x5AC8FA,dims:["r","h"],formulas:["V = Ï€rÂ²h","Q = mcÎ”T"]}},
  "potted plant":{icon:"ğŸŒ¿",label:"Pianta",tagline:"Fotosintesi â€” energia di Gibbs",subject:"CHIMICA",
    main:"6COâ‚‚+6Hâ‚‚O â†’ Câ‚†Hâ‚â‚‚Oâ‚†+6Oâ‚‚",alt:"Î”G = Î”H âˆ’ TÂ·Î”S",
    desc:"La fotosintesi converte luce in glucosio. Ãˆ endotermica: ha bisogno di fotoni solari. L'energia libera di Gibbs Î”G governa la spontaneitÃ : Î”G < 0 â†’ spontanea, Î”G > 0 â†’ non spontanea.",
    fact:"Le piante producono 120 miliardi di tonnellate di glucosio l'anno, assorbendo 180 Gt di COâ‚‚.",
    vars:[{s:"Î”G",n:"Energia di Gibbs [J]"},{s:"Î”H",n:"Entalpia [J]"},{s:"Î”S",n:"Entropia [J/K]"},{s:"T",n:"Temperatura [K]"}],
    model:{type:"sphere",color:0x5AC8FA,dims:["r"],formulas:["V = 4/3Â·Ï€rÂ³","S = 4Ï€rÂ²"]}},
  "vase":{icon:"ğŸº",label:"Vaso",tagline:"Solido di rivoluzione",subject:"MATEMATICA â€” ANALISI",
    main:"V = Ï€ âˆ« [f(x)]Â² dx",alt:"S = 2Ï€ âˆ« f(x)âˆš(1+fâ€²Â²)dx",
    desc:"Il vaso Ã¨ un solido di rivoluzione: si genera ruotando f(x) attorno all'asse verticale. Il volume si calcola integrando le sezioni circolari. Pappo di Alessandria formulÃ² questo principio nel III sec.",
    fact:"Il vasaio modella intuitivamente f(x) sul tornio: la rotazione genera il volume.",
    vars:[{s:"V",n:"Volume [mÂ³]"},{s:"f(x)",n:"Profilo (raggio)"},{s:"S",n:"Superficie laterale"},{s:"Ï€",n:"3.14159â€¦"}],
    model:{type:"lathe",color:0x5AC8FA,dims:["f(x)"],formulas:["V = Ï€âˆ«fÂ²dx","S = 2Ï€âˆ«fÂ·ds"]}},
  "clock":{icon:"â°",label:"Orologio",tagline:"Pendolo â€” oscillatore armonico",subject:"FISICA â€” OSCILLAZIONI",
    main:"T = 2Ï€ âˆš(L/g)",alt:"x(t) = AÂ·cos(Ï‰t+Ï†)",
    desc:"Il pendolo oscilla con periodo T dipendente solo da L e g, non dalla massa. Galileo scoprÃ¬ questa isocronia osservando un lampadario. Il moto Ã¨ descritto da una funzione coseno nel tempo.",
    fact:"Un pendolo di 1 metro: T = 2.006 s â€” quasi esattamente 2 secondi!",
    vars:[{s:"T",n:"Periodo [s]"},{s:"L",n:"Lunghezza filo [m]"},{s:"g",n:"9.81 m/sÂ²"},{s:"Ï‰=2Ï€/T",n:"Pulsazione [rad/s]"}],
    model:{type:"pendulum",color:0x5AC8FA,dims:["L","m"],formulas:["T = 2Ï€âˆš(L/g)","x = AÂ·cos(Ï‰t+Ï†)"]}},
  "sports ball":{icon:"âš½",label:"Pallone",tagline:"Sfera â€” moto parabolico",subject:"GEOMETRIA + FISICA",
    main:"xÂ² + yÂ² + zÂ² = rÂ²",alt:"x_max = vâ‚€Â²Â·sin(2Î¸)/g",
    desc:"Il pallone Ã¨ una sfera: equidistante dal centro in ogni direzione. Lanciato, descrive una parabola. La gittata massima si ottiene a Î¸=45Â°. L'effetto Magnus (rotazione) causa la curva delle punizioni.",
    fact:"Con vâ‚€=33 m/s e Î¸=45Â°, la gittata teorica Ã¨ ~111 m â€” la larghezza di un campo!",
    vars:[{s:"r",n:"Raggio [m]"},{s:"vâ‚€",n:"Vel. iniziale [m/s]"},{s:"Î¸",n:"Angolo di lancio"},{s:"g",n:"9.81 m/sÂ²"}],
    model:{type:"sphere",color:0x5AC8FA,dims:["r = 11cm"],formulas:["xÂ²+yÂ²+zÂ²=rÂ²","S = 4Ï€rÂ²","V = 4/3Ï€rÂ³"]}},
  "bowl":{icon:"ğŸ¥£",label:"Ciotola",tagline:"Paraboloide â€” sezione conica",subject:"GEOMETRIA ANALITICA",
    main:"y = xÂ² / (4p)",alt:"dist(P,F) = dist(P,direttrice)",
    desc:"La ciotola ha sezione parabolica. La parabola Ã¨ il luogo dei punti equidistanti dal fuoco e dalla direttrice. Le antenne paraboliche concentrano tutti i segnali nel fuoco grazie a questa proprietÃ .",
    fact:"La parabola riflette tutti i raggi paralleli nel fuoco â€” principio di antenne e telescopi.",
    vars:[{s:"p",n:"Dist. vertice-fuoco"},{s:"F",n:"Fuoco (0,p)"},{s:"y",n:"Ordinata"},{s:"x",n:"Ascissa"}],
    model:{type:"paraboloid",color:0x5AC8FA,dims:["r","h"],formulas:["y = xÂ²/(4p)","V = Ï€rÂ²h/2"]}},
  "lamp":{icon:"ğŸ’¡",label:"Lampada",tagline:"Equazione della sfera nello spazio",subject:"GEOMETRIA ANALITICA",
    main:"xÂ² + yÂ² + zÂ² = rÂ²",alt:"(xâˆ’a)Â²+(yâˆ’b)Â²+(zâˆ’c)Â² = rÂ²",
    desc:"La lampadina sferica: ogni punto sulla superficie Ã¨ equidistante dal centro. La sfera minimizza il rapporto superficie/volume â€” le bolle di sapone sono sferiche per questa ragione fisica.",
    fact:"Raddoppiando r, la superficie quadruplica ma il volume ottuplica. Ecco perchÃ© gli elefanti hanno orecchie grandi: piÃ¹ superficie per disperdere il calore.",
    vars:[{s:"r",n:"Raggio [m]"},{s:"(a,b,c)",n:"Centro"},{s:"S=4Ï€rÂ²",n:"Superficie"},{s:"V=4/3Ï€rÂ³",n:"Volume"}],
    model:{type:"sphere",color:0x5AC8FA,dims:["r","O(0,0,0)"],formulas:["xÂ²+yÂ²+zÂ²=rÂ²","S = 4Ï€rÂ²","V = 4/3Ï€rÂ³"]}},
  "window":{icon:"ğŸªŸ",label:"Finestra",tagline:"Legge di Snell â€” rifrazione ottica",subject:"OTTICA",
    main:"nâ‚Â·sinÎ¸â‚ = nâ‚‚Â·sinÎ¸â‚‚",alt:"n = c/v",
    desc:"La luce cambia velocitÃ  attraversando il vetro (nâ‰ˆ1.5) e si rifrange. La legge di Snell mette in relazione angoli e indici di rifrazione. Lenti, prismi e fibre ottiche sfruttano questa proprietÃ .",
    fact:"Un diamante ha n=2.42. Il taglio brillante fa rimbalzare la luce all'interno per riflessione totale â€” per questo brilla cosÃ¬ tanto.",
    vars:[{s:"n",n:"Indice di rifrazione"},{s:"Î¸â‚",n:"Angolo incidenza"},{s:"Î¸â‚‚",n:"Angolo rifrazione"},{s:"v",n:"Vel. luce nel mezzo"}],
    model:{type:"refraction",color:0x5AC8FA,dims:["Î¸â‚","Î¸â‚‚","nâ‚","nâ‚‚"],formulas:["nâ‚sinÎ¸â‚=nâ‚‚sinÎ¸â‚‚","n = c/v"]}},
  "door":{icon:"ğŸšª",label:"Porta",tagline:"Momento torcente â€” leva",subject:"FISICA â€” MECCANICA",
    main:"Ï„ = F Â· d Â· sinÎ¸",alt:"W = Ï„ Â· Î”Î¸",
    desc:"Aprire una porta richiede un momento torcente Ï„=FÂ·d rispetto all'asse delle cerniere. PiÃ¹ la forza Ã¨ applicata lontano dall'asse (grande d), minore Ã¨ la forza necessaria per lo stesso effetto.",
    fact:"Se la maniglia fosse a metÃ  porta (d/2), servirebbe il doppio della forza per aprirla!",
    vars:[{s:"Ï„",n:"Momento torcente [NÂ·m]"},{s:"F",n:"Forza [N]"},{s:"d",n:"Distanza dall'asse [m]"},{s:"Î¸",n:"Angolo F-braccio"}],
    model:{type:"box",color:0x5AC8FA,dims:["90cm","210cm"],formulas:["Ï„ = FÂ·dÂ·sinÎ¸","W = Ï„Â·Î”Î¸"]}},
  "refrigerator":{icon:"ğŸ§Š",label:"Frigorifero",tagline:"Macchina termica inversa â€” COP",subject:"FISICA â€” TERMODINAMICA",
    main:"COP = Q_c / W",alt:"Î·_Carnot = 1 âˆ’ T_c/T_h",
    desc:"Il frigorifero Ã¨ una pompa di calore: trasferisce energia termica dal freddo al caldo spendendo lavoro. Il COP misura l'efficienza: un buon frigo spende 1 kWh per spostarne 3.",
    fact:"Il secondo principio: il calore non va mai spontaneamente dal freddo al caldo. Serve sempre un lavoro esterno.",
    vars:[{s:"COP",n:"Coeff. prestazione"},{s:"Q_c",n:"Calore sottratto [J]"},{s:"W",n:"Lavoro speso [J]"},{s:"T",n:"Temperatura [K]"}],
    model:{type:"box",color:0x5AC8FA,dims:["60cm","180cm","65cm"],formulas:["COP = Qc/W","Î· = 1âˆ’Tc/Th"]}},
  "bicycle":{icon:"ğŸš²",label:"Bicicletta",tagline:"Momento angolare â€” toro",subject:"FISICA â€” MECCANICA ROTATORIA",
    main:"L = I Â· Ï‰",alt:"I_disco = Â½ m rÂ²",
    desc:"La ruota Ã¨ un toro. Il suo momento angolare L=IÏ‰ si conserva in assenza di coppie esterne, stabilizzando la bicicletta. PiÃ¹ gira veloce, piÃ¹ Ã¨ difficile farla cadere.",
    fact:"Un giroscopio sfrutta lo stesso principio ed Ã¨ usato nei satelliti e nei sistemi GPS.",
    vars:[{s:"L",n:"Momento angolare"},{s:"I",n:"Momento d'inerzia"},{s:"Ï‰",n:"Vel. angolare [rad/s]"},{s:"r",n:"Raggio [m]"}],
    model:{type:"torus",color:0x5AC8FA,dims:["R = 35cm","r = 4cm"],formulas:["L = IÏ‰","I = mRÂ²"]}},
  "car":{icon:"ğŸš—",label:"Auto",tagline:"Moto uniformemente accelerato â€” MRUA",subject:"FISICA â€” CINEMATICA",
    main:"s = vâ‚€t + Â½atÂ²",alt:"vÂ² = vâ‚€Â² + 2as",
    desc:"L'auto in MRUA percorre uno spazio che cresce col quadrato del tempo. Lo 0-100 in 8s corrisponde a aâ‰ˆ3.5 m/sÂ². In quei 8 secondi si percorrono circa 112 metri.",
    fact:"Una F1 fa 0-100 in ~2s con aâ‰ˆ14 m/sÂ² â€” 1.5g! Il pilota sente il peso aumentare del 50%.",
    vars:[{s:"s",n:"Spazio [m]"},{s:"vâ‚€",n:"Vel. iniziale [m/s]"},{s:"a",n:"Accelerazione [m/sÂ²]"},{s:"t",n:"Tempo [s]"}],
    model:{type:"box",color:0x5AC8FA,dims:["180cm","55cm","85cm"],formulas:["s = vâ‚€t+Â½atÂ²","v = vâ‚€+at"]}},
};

const ALIAS={
  "tvmonitor":"tv","sofa":"couch","pottedplant":"potted plant",
  "diningtable":"dining table","cellphone":"cell phone",
  "sportsball":"sports ball","mobilephone":"cell phone","remote":"tv","monitor":"tv",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let renderer, scene, camera, animId, wireShowing = false;
const ts = {active:false,last:{x:0,y:0},pinch:0,rx:0.3,ry:0.4,zoom:1.0};

function initThree(){
  const canvas = document.getElementById('threeCanvas');
  const wrap   = document.getElementById('threeWrap');
  renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  resizeThree();
  scene  = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(45, wrap.clientWidth/wrap.clientHeight, 0.01, 100);
  camera.position.set(0, 0, 3);
  // Touch events
  const el = wrap;
  el.addEventListener('touchstart', e=>{
    e.preventDefault(); ts.active=true;
    if(e.touches.length===1) ts.last={x:e.touches[0].clientX,y:e.touches[0].clientY};
    else ts.pinch=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
  },{passive:false});
  el.addEventListener('touchmove', e=>{
    e.preventDefault();
    if(e.touches.length===1){
      ts.ry+=(e.touches[0].clientX-ts.last.x)*0.012;
      ts.rx+=(e.touches[0].clientY-ts.last.y)*0.012;
      ts.last={x:e.touches[0].clientX,y:e.touches[0].clientY};
    } else {
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      ts.zoom*=d/ts.pinch; ts.zoom=Math.max(.3,Math.min(4,ts.zoom)); ts.pinch=d;
    }
  },{passive:false});
  el.addEventListener('touchend',()=>{ts.active=false;});
  let md=false,ml={x:0,y:0};
  el.addEventListener('mousedown',e=>{md=true;ml={x:e.clientX,y:e.clientY};ts.active=true;});
  window.addEventListener('mousemove',e=>{if(!md)return;ts.ry+=(e.clientX-ml.x)*.008;ts.rx+=(e.clientY-ml.y)*.008;ml={x:e.clientX,y:e.clientY};});
  window.addEventListener('mouseup',()=>{md=false;ts.active=false;});
  el.addEventListener('wheel',e=>{ts.zoom*=e.deltaY>0?.93:1.07;ts.zoom=Math.max(.3,Math.min(4,ts.zoom));});
}

function resizeThree(){
  const w=document.getElementById('threeWrap');
  if(!renderer||!w) return;
  renderer.setSize(w.clientWidth, w.clientHeight);
  if(camera){camera.aspect=w.clientWidth/w.clientHeight;camera.updateProjectionMatrix();}
}

function buildModel(data){
  if(animId) cancelAnimationFrame(animId);
  if(!scene) return;
  scene.clear();
  // Lights
  scene.add(new THREE.AmbientLight(0xffffff,0.55));
  const dl=new THREE.DirectionalLight(0x5AC8FA,1.3); dl.position.set(2,3,4); scene.add(dl);
  const dl2=new THREE.DirectionalLight(0xffffff,0.35); dl2.position.set(-2,-1,-2); scene.add(dl2);

  const c=data.model.color||0x5AC8FA;
  const matFill=new THREE.MeshPhongMaterial({color:c,transparent:true,opacity:0.15,side:THREE.DoubleSide,depthWrite:false});
  const matWire=new THREE.MeshBasicMaterial({color:c,wireframe:true,transparent:true,opacity:.80});
  const matEdge=new THREE.LineBasicMaterial({color:c,transparent:true,opacity:.90});

  let geo;
  const m=data.model;

  if(m.type==='sphere')       geo=new THREE.SphereGeometry(.9,48,32);
  else if(m.type==='cylinder') geo=new THREE.CylinderGeometry(.5,.6,1.8,48,1,false);
  else if(m.type==='box')      geo=new THREE.BoxGeometry(1.8,1.1,1.1);
  else if(m.type==='torus')    geo=new THREE.TorusGeometry(.8,.18,18,80);
  else if(m.type==='paraboloid') geo=makeParaboloid(.8,.7);
  else if(m.type==='lathe')    geo=makeLathe();
  else if(m.type==='pendulum') {buildPendulum(c); return;}
  else if(m.type==='refraction'){buildRefraction(c); return;}
  else                         geo=new THREE.SphereGeometry(.9,48,32);

  scene.add(new THREE.Mesh(geo,matFill));
  scene.add(new THREE.Mesh(geo,matWire));
  scene.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo,18),matEdge));
  addAxes();
  addDimLabels(data);
  ts.rx=.3; ts.ry=.4; ts.zoom=1; wireShowing=false;
  startLoop();
}

function makeParaboloid(r,h){
  const pts=[];
  for(let i=0;i<=24;i++){const t=i/24; pts.push(new THREE.Vector2(r*t*t,h*t-h/2));}
  return new THREE.LatheGeometry(pts,48);
}
function makeLathe(){
  return new THREE.LatheGeometry([
    new THREE.Vector2(0,-1.1),new THREE.Vector2(.32,-.9),new THREE.Vector2(.52,-.4),
    new THREE.Vector2(.46,.1),new THREE.Vector2(.38,.5),new THREE.Vector2(.48,.88),
    new THREE.Vector2(.42,1.0),new THREE.Vector2(.18,1.15)
  ],48);
}

function buildPendulum(c){
  const lm=new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:.6});
  // string
  const sg=new THREE.CylinderGeometry(.012,.012,1.8,8);
  const str=new THREE.Mesh(sg,lm); str.position.y=0; scene.add(str);
  // bob
  const bg=new THREE.SphereGeometry(.22,32,20);
  scene.add(new THREE.Mesh(bg,new THREE.MeshPhongMaterial({color:c,transparent:true,opacity:.18,side:THREE.DoubleSide})));
  scene.add(new THREE.Mesh(bg,new THREE.MeshBasicMaterial({color:c,wireframe:true,transparent:true,opacity:.75})));
  const bob2=scene.children[scene.children.length-1];
  bob2.position.y=-1.0;
  scene.children[scene.children.length-2].position.y=-1.0;
  // pivot
  const pg=new THREE.SphereGeometry(.07,16,12);
  const piv=new THREE.Mesh(pg,new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:.9}));
  piv.position.y=.95; scene.add(piv);
  addAxes();
  let t=0;
  function loop(){
    animId=requestAnimationFrame(loop);
    t+=.022; const a=.42*Math.sin(t);
    str.rotation.z=a;
    const bx=1.85*Math.sin(a), by=-1.0*Math.cos(a);
    scene.children.forEach((o,i)=>{
      if(i===1||i===2){o.position.x=bx;o.position.y=by;}
    });
    if(!ts.active) ts.ry+=.004;
    scene.rotation.y=ts.ry; scene.rotation.x=ts.rx;
    camera.position.z=3/ts.zoom; camera.updateProjectionMatrix();
    renderer.render(scene,camera);
  }
  loop();
}

function buildRefraction(c){
  // glass slab
  const sg=new THREE.BoxGeometry(2.4,.55,.1);
  scene.add(new THREE.Mesh(sg,new THREE.MeshPhongMaterial({color:0xaaddff,transparent:true,opacity:.14,side:THREE.DoubleSide})));
  scene.add(new THREE.Mesh(sg,new THREE.MeshBasicMaterial({color:c,wireframe:true,transparent:true,opacity:.4})));
  // rays
  addLine([new THREE.Vector3(-1.1,.9,0),new THREE.Vector3(0,.28,0)],0xffaa00);
  addLine([new THREE.Vector3(0,.28,0),new THREE.Vector3(.55,-.28,0)],c);
  addLine([new THREE.Vector3(.55,-.28,0),new THREE.Vector3(1.1,-.9,0)],0xffaa00);
  addDash([new THREE.Vector3(0,.85,0),new THREE.Vector3(0,-.85,0)],0xffffff);
  addAxes();
  startLoop();
}

function addLine(pts,col){
  const g=new THREE.BufferGeometry().setFromPoints(pts);
  scene.add(new THREE.Line(g,new THREE.LineBasicMaterial({color:col,transparent:true,opacity:.88,linewidth:2})));
}
function addDash(pts,col){
  const g=new THREE.BufferGeometry().setFromPoints(pts);
  const m=new THREE.LineDashedMaterial({color:col,dashSize:.08,gapSize:.06,transparent:true,opacity:.45});
  const l=new THREE.Line(g,m); l.computeLineDistances(); scene.add(l);
}

function addAxes(){
  [[1,0,0,0xff4444],[0,1,0,0x44cc44],[0,0,1,0x4488ff]].forEach(([x,y,z,col])=>{
    const g=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(x*1.3,y*1.3,z*1.3)]);
    scene.add(new THREE.Line(g,new THREE.LineBasicMaterial({color:col,transparent:true,opacity:.32})));
  });
}

function addDimLabels(data){
  // We'll inject HTML labels positioned over the 3D area
  const wrap=document.getElementById('threeWrap');
  document.querySelectorAll('.dlabel').forEach(e=>e.remove());
  const positions=[
    {t:'8%',l:'8%'},{t:'8%',r:'8%'},{b:'36px',l:'8%'},{b:'36px',r:'8%'}
  ];
  (data.model.formulas||[]).forEach((txt,i)=>{
    if(i>3) return;
    const el=document.createElement('div');
    el.className='dlabel';
    el.textContent=txt;
    Object.assign(el.style, positions[i]||{t:'50%',l:'50%'});
    el.style.position='absolute';
    wrap.appendChild(el);
  });
}

function startLoop(){
  function loop(){
    animId=requestAnimationFrame(loop);
    if(!ts.active) ts.ry+=.005;
    scene.rotation.y=ts.ry; scene.rotation.x=ts.rx;
    camera.position.z=3/ts.zoom; camera.updateProjectionMatrix();
    renderer.render(scene,camera);
  }
  loop();
}

function resetCam(){ts.rx=.3;ts.ry=.4;ts.zoom=1;}
function toggleWire(){
  wireShowing=!wireShowing;
  scene.traverse(o=>{
    if(o.isMesh&&!o.material.wireframe){
      o.material.opacity=wireShowing?0:.15;
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tfModel=null, detections=[];
const video=document.getElementById('video');
const cvD=document.getElementById('cvDetect');
const ctxD=cvD.getContext('2d');

async function init(){
  document.getElementById('permScreen').classList.add('gone');
  setStatus("Avvio fotocameraâ€¦"); setLoad(true,0);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false});
    video.srcObject=stream;
    await new Promise(r=>video.onloadedmetadata=r);
    resizeCv();
  }catch(e){
    setStatus("Fotocamera non disponibile"); setLoad(true,100);
    setTimeout(()=>setLoad(false),600); startDemo(); return;
  }
  setStatus("Avvio rilevamentoâ€¦"); setLoad(true,30);
  try{
    tfModel=await cocoSsd.load({base:'mobilenet_v2'});
    setLoad(true,90);
  }catch(e){
    setStatus("Rilevamento non disponibile"); setLoad(true,100);
    setTimeout(()=>setLoad(false),600); startDemo(); return;
  }
  setLoad(true,100); setTimeout(()=>setLoad(false),500);
  setStatus("Pronto â€” punta il dispositivo");
  setTimeout(()=>{document.getElementById('statusChip').style.opacity='0';},3000);
  initThree(); startLoop2();
}

window.addEventListener('resize',()=>{resizeCv();resizeThree();});
function resizeCv(){
  cvD.width=innerWidth; cvD.height=innerHeight;
}

function startLoop2(){
  let last=0;
  async function tick(ts){
    requestAnimationFrame(tick);
    if(ts-last<620) return; last=ts;
    if(video.readyState<2) return;
    try{
      const preds=await tfModel.detect(video,10,0.28);
      process(preds);
    }catch(_){}
  }
  requestAnimationFrame(tick);
}

function process(preds){
  const seen=new Set(), found=[];
  for(const p of preds){
    let cls=p.class.toLowerCase();
    if(ALIAS[cls]) cls=ALIAS[cls];
    if(seen.has(cls)) continue;
    seen.add(cls);
    const data=DB[cls];
    if(!data) continue;
    found.push({cls,score:p.score,bbox:p.bbox,data});
  }
  found.sort((a,b)=>b.score-a.score);
  drawBoxes(found);
  reconcile(found);
}

function drawBoxes(found){
  ctxD.clearRect(0,0,cvD.width,cvD.height);
  if(!video.videoWidth) return;
  const sx=cvD.width/video.videoWidth, sy=cvD.height/video.videoHeight;
  for(const det of found){
    const [bx,by,bw,bh]=det.bbox;
    const x=bx*sx, y=by*sy, w=bw*sx, h=bh*sy, r=12;
    const pct=det.score;
    const stroke=pct>.80?'rgba(90,200,250,.92)':pct>.55?'rgba(255,214,10,.88)':'rgba(255,255,255,.72)';
    // box
    ctxD.shadowColor=stroke; ctxD.shadowBlur=12;
    ctxD.beginPath();
    ctxD.moveTo(x+r,y);ctxD.lineTo(x+w-r,y);ctxD.quadraticCurveTo(x+w,y,x+w,y+r);
    ctxD.lineTo(x+w,y+h-r);ctxD.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    ctxD.lineTo(x+r,y+h);ctxD.quadraticCurveTo(x,y+h,x,y+h-r);
    ctxD.lineTo(x,y+r);ctxD.quadraticCurveTo(x,y,x+r,y);ctxD.closePath();
    ctxD.fillStyle='rgba(90,200,250,.04)'; ctxD.fill();
    ctxD.strokeStyle=stroke; ctxD.lineWidth=1.8; ctxD.stroke();
    ctxD.shadowBlur=0;
    // corner brackets
    const bl=16; ctxD.strokeStyle=stroke; ctxD.lineWidth=2.4;
    [[x,y,bl,bl],[x+w,y,-bl,bl],[x,y+h,bl,-bl],[x+w,y+h,-bl,-bl]].forEach(([cx,cy,dx,dy])=>{
      ctxD.beginPath();ctxD.moveTo(cx+dx,cy);ctxD.lineTo(cx,cy);ctxD.lineTo(cx,cy+dy);ctxD.stroke();
    });
    // label
    const lbl=det.data.icon+' '+det.data.label+'  '+Math.round(pct*100)+'%';
    ctxD.font='600 12px Inter,-apple-system,sans-serif';
    const tw=ctxD.measureText(lbl).width;
    const lw=tw+16,lh=24,lx2=x,ly2=Math.max(4,y-lh-6);
    ctxD.fillStyle='rgba(8,10,20,.78)';
    ctxD.beginPath();ctxD.roundRect(lx2,ly2,lw,lh,6);ctxD.fill();
    ctxD.strokeStyle=stroke;ctxD.lineWidth=.8;ctxD.stroke();
    ctxD.fillStyle='#fff';ctxD.fillText(lbl,lx2+8,ly2+16);
    // formula in box
    if(w>100&&h>70){
      ctxD.font='italic 13px Georgia,serif';
      ctxD.fillStyle='rgba(90,200,250,.55)';
      ctxD.textAlign='center';
      ctxD.fillText(det.data.main,x+w/2,y+h/2+5);
      ctxD.textAlign='left';
    }
  }
}

function reconcile(found){
  const n=found.map(d=>d.cls).join('|');
  const c=detections.map(d=>d.cls).join('|');
  if(n===c) return;
  detections=found;
  const list=document.getElementById('pillList');
  list.innerHTML='';
  found.forEach((det,i)=>{
    const pill=document.createElement('div');
    pill.className='pill';
    pill.style.animationDelay=(i*50)+'ms';
    pill.innerHTML=`
      <span class="pill-icon">${det.data.icon}</span>
      <span class="pill-label">${det.data.label}</span>
      <span class="pill-3d">3D</span>
      <span class="pill-conf">${Math.round(det.score*100)}%</span>`;
    pill.onclick=()=>openViewer(det.data,Math.round(det.score*100));
    list.appendChild(pill);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openViewer(data,conf){
  document.querySelectorAll('.pill').forEach(p=>
    p.classList.toggle('selected',p.querySelector('.pill-label')?.textContent===data.label));
  // Build 3D
  if(!renderer) initThree();
  buildModel(data);
  // Sheet
  document.getElementById('sheetBody').innerHTML=`
    <div class="stag">${data.subject}</div>
    <div class="sname">${data.icon}&ensp;${data.label}</div>
    <div class="stagline">${data.tagline}</div>
    ${conf?`<div class="cbadge"><span class="cdot"></span>Rilevato con ${conf}% di accuratezza</div>`:''}
    <div class="fblock">
      <div class="fmain">${data.main}</div>
      <div class="falt">${data.alt}</div>
    </div>
    <div class="sdiv"></div>
    <div class="dtitle">Spiegazione</div>
    <div class="sdesc">${data.desc}</div>
    ${data.fact?`<div class="ffact"><div class="fftext"><strong>ğŸ’¡ Lo sapevi?</strong>&nbsp;${data.fact}</div></div>`:''}
    <div class="vtitle">Variabili</div>
    <div class="vgrid">${data.vars.map(v=>`
      <div class="vitem"><div class="vsym">${v.s}</div><div class="vname">${v.n}</div></div>`).join('')}
    </div>
    <div class="lbtn">â†’ Apri la lezione nell'app</div>
  `;
  document.getElementById('viewer').classList.add('open');
  setTimeout(()=>{document.getElementById('arHint').style.opacity='0';},4000);
}

function closeViewer(){
  document.getElementById('viewer').classList.remove('open');
  if(animId) cancelAnimationFrame(animId);
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('selected'));
  document.querySelectorAll('.dlabel').forEach(e=>e.remove());
}

// swipe down
let ty0=0;
document.getElementById('viewerPanel').addEventListener('touchstart',e=>{ty0=e.touches[0].clientY;},{passive:true});
document.getElementById('viewerPanel').addEventListener('touchmove',e=>{
  if(e.touches[0].clientY-ty0>80) closeViewer();
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDemo(){
  initThree();
  const seq=["lamp","bowl","bottle","clock","sports ball","vase","cup","bicycle"];
  let i=0;
  const show=()=>{
    const data=DB[seq[i++%seq.length]];
    if(!data) return;
    const score=.88+Math.random()*.10;
    detections=[{cls:seq[(i-1)%seq.length],score,bbox:[60,120,240,220],data}];
    const list=document.getElementById('pillList');
    list.innerHTML='';
    const pill=document.createElement('div');
    pill.className='pill';
    pill.innerHTML=`<span class="pill-icon">${data.icon}</span><span class="pill-label">${data.label}</span><span class="pill-3d">3D</span><span class="pill-conf">${Math.round(score*100)}%</span>`;
    pill.onclick=()=>openViewer(data,Math.round(score*100));
    list.appendChild(pill);
  };
  show(); setInterval(show,5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goBack(){
  if(document.referrer){history.back();return;}
  if(window.history.length>1){history.back();return;}
  const p=window.location.pathname;
  const par=p.substring(0,p.lastIndexOf('/demo1'));
  window.location.href=window.location.origin+(par||'')+'/index.html';
}
function setStatus(msg){const el=document.getElementById('statusChip');el.textContent=msg;el.style.opacity='1';}
function setLoad(on,pct){
  document.getElementById('loadBar').classList.toggle('on',on);
  if(pct!==undefined) document.getElementById('loadFill').style.width=pct+'%';
}
function checkOri(){
  const l=innerWidth>innerHeight, s=Math.min(innerWidth,innerHeight)<500;
  document.getElementById('rotOv').classList.toggle('show',l&&s);
}
window.addEventListener('resize',checkOri);
window.addEventListener('orientationchange',checkOri);
checkOri();
</script>
</body>
</html>
